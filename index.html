<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¢—Ä–µ–∫–µ—Ä | Telegram Web App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #40a7e3;
            --income-color: #4CAF50;
            --expense-color: #f44336;
            --goal-color: #FF9800;
            --investment-color: #9C27B0;
            --savings-color: #00BCD4;
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --text-color: var(--tg-theme-text-color, #000000);
            --card-bg: var(--tg-theme-secondary-bg-color, #f8f9fa);
            --border-color: var(--tg-theme-hint-color, #e0e0e0);
            --button-color: var(--tg-theme-button-color, #40a7e3);
            --button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --transaction-bg: var(--tg-theme-secondary-bg-color, #f8f9fa);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            height: 100vh;
            height: -webkit-fill-available;
            scroll-behavior: smooth;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            padding: 16px 16px 80px;
            max-width: 100%;
            overflow-x: hidden;
            line-height: 1.6;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            touch-action: pan-y;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            animation: fadeIn 0.5s ease;
            padding-top: 60px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--bg-color);
            z-index: 999;
            padding: 10px 16px;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .header h1 {
            font-size: 20px;
            color: var(--primary-color);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        #currentDate {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #666);
        }
        
        .balance-card {
            background: linear-gradient(135deg, #2d8bc8, #1a6da4);
            color: white;
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }
        
        .balance-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.3;
        }
        
        .balance-amount {
            font-size: 42px;
            font-weight: 900;
            margin: 15px 0;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.4);
            letter-spacing: 0.5px;
        }
        
        #balanceChange {
            font-size: 16px;
            font-weight: 600;
            opacity: 0.95;
            margin-top: 5px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.2s;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .stat-card.income { border-top: 4px solid var(--income-color); }
        .stat-card.expense { border-top: 4px solid var(--expense-color); }
        .stat-card.savings { border-top: 4px solid var(--savings-color); }
        .stat-card.investments { border-top: 4px solid var(--investment-color); }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .stat-card.income .stat-value { color: var(--income-color); }
        .stat-card.expense .stat-value { color: var(--expense-color); }
        .stat-card.savings .stat-value { color: var(--savings-color); }
        .stat-card.investments .stat-value { color: var(--investment-color); }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 8px;
            background: var(--card-bg);
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-color);
            border: 2px solid transparent;
            min-height: 70px;
        }
        
        .action-btn:hover {
            border-color: var(--primary-color);
            transform: scale(1.02);
        }
        
        .action-btn i {
            font-size: 22px;
            margin-bottom: 5px;
        }
        
        .action-btn.income i { color: var(--income-color); }
        .action-btn.expense i { color: var(--expense-color); }
        .action-btn.goal i { color: var(--goal-color); }
        .action-btn.investment i { color: var(--investment-color); }
        
        .section {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        
        .section-title i {
            color: var(--primary-color);
        }
        
        .see-all {
            font-size: 14px;
            color: var(--primary-color);
            text-decoration: none;
            cursor: pointer;
        }
        
        .chart-container {
            height: 250px;
            margin: 15px 0;
            position: relative;
        }
        
        .chartjs-legend .legend-item {
            color: var(--text-color) !important;
            font-weight: 600 !important;
        }
        
        .chartjs-tooltip {
            background: var(--card-bg) !important;
            color: var(--text-color) !important;
            border: 1px solid var(--border-color) !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
        }
        
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--transaction-bg);
            border-radius: 12px;
            margin-bottom: 8px;
            border-left: 5px solid;
            border-right: 1px solid var(--border-color);
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }
        
        .transaction-income { 
            border-left-color: var(--income-color);
            background: linear-gradient(90deg, rgba(76, 175, 80, 0.15) 0%, var(--transaction-bg) 100%);
        }
        .transaction-expense { 
            border-left-color: var(--expense-color);
            background: linear-gradient(90deg, rgba(244, 67, 54, 0.15) 0%, var(--transaction-bg) 100%);
        }
        
        .transaction-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .transaction-income .transaction-icon {
            background: rgba(76, 175, 80, 0.15);
            color: var(--income-color);
        }
        
        .transaction-expense .transaction-icon {
            background: rgba(244, 67, 54, 0.15);
            color: var(--expense-color);
        }
        
        .transaction-info {
            flex: 1;
        }
        
        .transaction-category {
            font-weight: 600;
            margin-bottom: 3px;
            color: var(--text-color);
        }
        
        .transaction-description {
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 3px;
        }
        
        .transaction-date {
            font-size: 12px;
            color: var(--text-color);
            opacity: 0.6;
        }
        
        .transaction-amount {
            font-weight: bold;
            font-size: 16px;
            text-align: right;
        }
        
        .transaction-income .transaction-amount {
            color: var(--income-color);
        }
        
        .transaction-expense .transaction-amount {
            color: var(--expense-color);
        }
        
        .transaction-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .transaction-item:hover .transaction-actions {
            opacity: 1;
        }
        
        .action-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--card-bg);
            color: var(--text-color);
            font-size: 12px;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }
        
        .action-icon:hover {
            background: var(--primary-color);
            color: white;
        }
        
        .goal-item {
            background: var(--bg-color);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        
        .goal-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--goal-color);
        }
        
        .goal-progress {
            margin: 10px 0;
        }
        
        .progress-bar {
            height: 10px;
            background: var(--border-color);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--goal-color), #FFB74D);
            border-radius: 5px;
            transition: width 1s ease;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.7;
        }
        
        .goal-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .goal-btn {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-color);
            flex: 1;
            text-align: center;
        }
        
        .goal-btn:hover {
            background: var(--primary-color);
            color: white;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            animation: fadeIn 0.3s ease;
            padding: 16px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-content {
            background: var(--bg-color);
            margin: 10% auto;
            padding: 25px;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
            position: relative;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .form-input {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            background: var(--card-bg);
            color: var(--text-color);
            transition: border-color 0.3s;
            -webkit-appearance: none;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .form-input.formatted {
            font-family: monospace;
            letter-spacing: 1px;
        }
        
        select.form-input {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23666' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            background-size: 16px;
            padding-right: 40px;
        }
        
        .nav-tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-color);
            z-index: 1000;
            padding: 10px 0 5px;
            max-width: 500px;
            margin: 0 auto;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            justify-content: space-around;
        }
        
        .nav-tab {
            flex: 1;
            padding: 8px 5px;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: var(--tg-theme-hint-color, #666);
            font-size: 12px;
            min-width: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60px;
        }
        
        .nav-tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .nav-tab i {
            display: block;
            margin-bottom: 3px;
            font-size: 20px;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
            padding-bottom: 80px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .loader {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 40px auto;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }
        
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--tg-theme-hint-color, #666);
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .financial-health {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 12px;
        }
        
        .health-score {
            font-size: 36px;
            font-weight: bold;
            min-width: 80px;
            text-align: center;
        }
        
        .health-score.excellent { color: #4CAF50; }
        .health-score.good { color: #FF9800; }
        .health-score.poor { color: #f44336; }
        
        .health-info {
            flex: 1;
        }
        
        .health-bar {
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .health-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 1s ease;
        }
        
        .health-fill.excellent { background: #4CAF50; }
        .health-fill.good { background: #FF9800; }
        .health-fill.poor { background: #f44336; }
        
        .advice-item {
            padding: 15px;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 165, 0, 0.1));
            border-radius: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #FFD700;
            position: relative;
            overflow: hidden;
        }
        
        .advice-item::before {
            content: 'üí°';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            opacity: 0.3;
        }
        
        .advice-item.high {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.1), rgba(229, 57, 53, 0.1));
            border-left-color: #f44336;
        }
        
        .advice-item.high::before {
            content: '‚ö†Ô∏è';
        }
        
        .advice-item.medium {
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.1), rgba(245, 124, 0, 0.1));
            border-left-color: #FF9800;
        }
        
        .investment-card {
            background: var(--bg-color);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--investment-color);
            position: relative;
        }
        
        .investment-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .investment-card:hover .investment-actions {
            opacity: 1;
        }
        
        .investment-performance {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .performance-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .performance-badge.positive {
            background: rgba(76, 175, 80, 0.15);
            color: var(--income-color);
        }
        
        .performance-badge.negative {
            background: rgba(244, 67, 54, 0.15);
            color: var(--expense-color);
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 8px 0;
            transition: all 0.3s;
            text-align: center;
            min-height: 50px;
        }
        
        .btn-primary {
            background: var(--button-color);
            color: var(--button-text-color);
        }
        
        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .btn-income {
            background: linear-gradient(135deg, var(--income-color), #45a049);
            color: white;
        }
        
        .btn-expense {
            background: linear-gradient(135deg, var(--expense-color), #d32f2f);
            color: white;
        }
        
        .btn-goal {
            background: linear-gradient(135deg, var(--goal-color), #F57C00);
            color: white;
        }
        
        .btn-investment {
            background: linear-gradient(135deg, var(--investment-color), #7B1FA2);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }
        
        .hidden { display: none !important; }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #f44336;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .goal-allocation-item {
            margin-bottom: 15px;
            padding: 10px;
            background: var(--bg-color);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-indicator.success {
            background: rgba(76, 175, 80, 0.15);
            color: #4CAF50;
        }
        
        .status-indicator.warning {
            background: rgba(255, 152, 0, 0.15);
            color: #FF9800;
        }
        
        .status-indicator.error {
            background: rgba(244, 67, 54, 0.15);
            color: #f44336;
        }
        
        .btn-loading {
            position: relative;
            color: transparent !important;
        }
        
        .btn-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .input-group .form-input {
            flex: 1;
        }
        
        .input-group .unit {
            font-size: 14px;
            color: var(--tg-theme-hint-color);
            min-width: 40px;
        }
        
        .formatted-input-container {
            position: relative;
        }
        
        .formatted-input-container .form-input {
            font-family: monospace;
            letter-spacing: 1px;
            padding-left: 40px;
        }
        
        .currency-symbol {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
            color: var(--text-color);
            font-family: monospace;
        }
        
        .referral-link {
            background: var(--bg-color);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 15px;
            position: relative;
        }
        
        .referral-link input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-color);
            margin-top: 10px;
            font-family: monospace;
            cursor: copy;
        }
        
        .copy-btn {
            position: absolute;
            right: 10px;
            bottom: 10px;
            padding: 6px 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .report-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .report-option {
            padding: 15px;
            background: var(--card-bg);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            border: 2px solid var(--border-color);
        }
        
        .report-option:hover {
            border-color: var(--primary-color);
        }
        
        .report-option i {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        
        @media (max-width: 480px) {
            .container { padding: 0 10px; padding-top: 60px; }
            .balance-amount { font-size: 36px; }
            .quick-actions { grid-template-columns: repeat(4, 1fr); }
            .action-btn span { display: block; font-size: 11px; }
            .action-btn i { font-size: 20px; margin-bottom: 5px; }
            .stats-grid { gap: 8px; }
            .stat-card { padding: 12px; min-height: 90px; }
            .stat-value { font-size: 20px; }
            .nav-tab { padding: 6px 3px; font-size: 11px; }
            .nav-tab i { font-size: 18px; }
            .modal-content { margin: 20px auto; padding: 20px; max-height: 85vh; }
            .section { padding: 15px; }
            .chart-container { height: 220px; }
            .report-options { grid-template-columns: 1fr; }
        }
        
        @supports (-webkit-touch-callout: none) {
            body {
                height: -webkit-fill-available;
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .tab-content.active {
            animation: fadeInUp 0.3s ease;
        }
        
        .success-check {
            display: inline-block;
            margin-right: 8px;
            animation: bounce 0.5s ease;
        }
        
        @keyframes bounce {
            0%, 20%, 60%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            80% { transform: translateY(-5px); }
        }
        
        .success-message {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--income-color);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            z-index: 9999;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeInOut 2s ease;
            max-width: 90%;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            15% { opacity: 1; transform: translateX(-50%) translateY(0); }
            85% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }
        
        /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ */
        .expense-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--card-bg);
            border-radius: 10px;
            margin-bottom: 8px;
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        
        .expense-detail-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(64, 167, 227, 0.95), rgba(42, 125, 188, 0.95));
            z-index: 10000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            animation: fadeIn 0.5s ease;
        }
        
        .welcome-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideUp 0.5s ease 0.3s both;
        }
        
        .category-visibility-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .category-visibility-btn:hover {
            background: #2d8bc8;
        }
        
        .memory-badge {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 5px 10px;
            font-size: 12px;
            margin-top: 5px;
            display: inline-block;
        }
        
        .chart-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.3s;
        }
        
        .chart-legend-item:hover {
            background: rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-chart-line pulse"></i> –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¢—Ä–µ–∫–µ—Ä</h1>
        <div id="currentDate">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
    
    <div class="container">
        <!-- –î–∞—à–±–æ—Ä–¥ -->
        <div id="dashboardTab" class="tab-content active">
            <div class="balance-card">
                <div>–í–∞—à –±–∞–ª–∞–Ω—Å</div>
                <div class="balance-amount" id="balanceAmount">0 ‚ÇΩ</div>
                <div id="balanceChange">+0 ‚ÇΩ –∑–∞ –º–µ—Å—è—Ü</div>
                <div id="balanceYesterday" style="font-size: 14px; opacity: 0.9; margin-top: 5px;">
                    <i class="fas fa-calendar-day"></i> –° –≤—á–µ—Ä–∞: –∑–∞–≥—Ä—É–∑–∫–∞...
                </div>
                <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;" id="lastUpdate">–û–±–Ω–æ–≤–ª–µ–Ω–æ: --:--</div>
            </div>
            
            <div class="financial-health" id="financialHealth">
                <div class="health-score" id="healthScore">0</div>
                <div class="health-info">
                    <div>–§–∏–Ω–∞–Ω—Å–æ–≤–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ</div>
                    <div class="health-bar">
                        <div class="health-fill" id="healthFill" style="width: 0%"></div>
                    </div>
                    <div style="font-size: 12px; margin-top: 5px;" id="healthStatus">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card income" onclick="showDetailedReport('income')">
                    <div><i class="fas fa-arrow-up"></i> –î–æ—Ö–æ–¥—ã</div>
                    <div class="stat-value" id="incomeValue">0 ‚ÇΩ</div>
                    <div style="font-size: 12px;" id="incomeCount">0 –æ–ø–µ—Ä–∞—Ü–∏–π</div>
                </div>
                <div class="stat-card expense" onclick="showDetailedReport('expense')">
                    <div><i class="fas fa-arrow-down"></i> –†–∞—Å—Ö–æ–¥—ã</div>
                    <div class="stat-value" id="expenseValue">0 ‚ÇΩ</div>
                    <div style="font-size: 12px;" id="expenseCount">0 –æ–ø–µ—Ä–∞—Ü–∏–π</div>
                </div>
                <div class="stat-card savings" onclick="switchTab('goals')">
                    <div><i class="fas fa-piggy-bank"></i> –°–±–µ—Ä–µ–∂–µ–Ω–∏—è</div>
                    <div class="stat-value" id="savingsValue">0%</div>
                    <div style="font-size: 12px;">–æ—Ç –¥–æ—Ö–æ–¥–æ–≤</div>
                </div>
                <div class="stat-card investments" onclick="switchTab('investments')">
                    <div><i class="fas fa-chart-line"></i> –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</div>
                    <div class="stat-value" id="investmentValue">0 ‚ÇΩ</div>
                    <div style="font-size: 12px;" id="investmentCount">0 –∞–∫—Ç–∏–≤–æ–≤</div>
                </div>
            </div>
            
            <div class="quick-actions">
                <button class="action-btn income" onclick="showTransactionModal('income')">
                    <i class="fas fa-plus-circle"></i>
                    <span>–î–æ—Ö–æ–¥</span>
                </button>
                <button class="action-btn expense" onclick="showTransactionModal('expense')">
                    <i class="fas fa-minus-circle"></i>
                    <span>–†–∞—Å—Ö–æ–¥</span>
                </button>
                <button class="action-btn goal" onclick="showGoalModal()">
                    <i class="fas fa-bullseye"></i>
                    <span>–¶–µ–ª—å</span>
                </button>
                <button class="action-btn investment" onclick="showInvestmentModal()">
                    <i class="fas fa-chart-line"></i>
                    <span>–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è</span>
                </button>
            </div>
            
            <div class="section">
                <div class="section-title">
                    <span><i class="fas fa-chart-line"></i> –î–∏–Ω–∞–º–∏–∫–∞ –∑–∞ –º–µ—Å—è—Ü</span>
                    <span class="see-all" onclick="updateLinearChart()">–û–±–Ω–æ–≤–∏—Ç—å</span>
                </div>
                <div class="chart-container">
                    <canvas id="linearChart"></canvas>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">
                    <span><i class="fas fa-chart-pie"></i> –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤</span>
                    <span class="see-all" onclick="showExpenseDetails()">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è ‚Üí</span>
                </div>
                <div class="chart-container">
                    <canvas id="expenseChart"></canvas>
                </div>
                <div style="font-size: 12px; color: var(--text-color); opacity: 0.7; text-align: center; margin-top: 10px;">
                    <i class="fas fa-mouse-pointer"></i> –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ —Å–µ–∫—Ç–æ—Ä—É - —Å–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">
                    <span><i class="fas fa-lightbulb"></i> –£–º–Ω—ã–µ —Å–æ–≤–µ—Ç—ã</span>
                    <span class="see-all" onclick="loadMoreAdvice()">–û–±–Ω–æ–≤–∏—Ç—å</span>
                </div>
                <div id="adviceContainer">
                    <div class="empty-state">
                        <i class="fas fa-lightbulb"></i>
                        <div>–î–æ–±–∞–≤—å—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–≤–µ—Ç–∞</div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">
                    <span><i class="fas fa-history"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</span>
                    <span class="see-all" onclick="switchTab('transactions')">–í—Å–µ ‚Üí</span>
                </div>
                <div id="recentTransactions">
                    <div class="empty-state">
                        <i class="fas fa-exchange-alt"></i>
                        <div>–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞ –º–µ—Å—è—Ü</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
        <div id="transactionsTab" class="tab-content">
            <div class="section">
                <div class="section-title">
                    <span><i class="fas fa-filter"></i> –§–∏–ª—å—Ç—Ä—ã</span>
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <select class="form-input" id="transactionTypeFilter" onchange="filterTransactions()">
                        <option value="all">–í—Å–µ —Ç–∏–ø—ã</option>
                        <option value="income">–î–æ—Ö–æ–¥—ã</option>
                        <option value="expense">–†–∞—Å—Ö–æ–¥—ã</option>
                    </select>
                    <select class="form-input" id="transactionPeriodFilter" onchange="filterTransactions()">
                        <option value="month">–ó–∞ –º–µ—Å—è—Ü</option>
                        <option value="week">–ó–∞ –Ω–µ–¥–µ–ª—é</option>
                        <option value="year">–ó–∞ –≥–æ–¥</option>
                        <option value="all">–ó–∞ –≤—Å—ë –≤—Ä–µ–º—è</option>
                    </select>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">
                    <span><i class="fas fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</span>
                    <span class="see-all" onclick="showTransactionModal('income')">–î–æ–±–∞–≤–∏—Ç—å</span>
                </div>
                <div id="transactionsList">
                    <div class="empty-state">
                        <i class="fas fa-exchange-alt"></i>
                        <div>–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –¶–µ–ª–∏ -->
        <div id="goalsTab" class="tab-content">
            <button class="btn btn-goal" onclick="showGoalModal()">
                <i class="fas fa-plus"></i> –ù–æ–≤–∞—è —Ü–µ–ª—å
            </button>
            
            <div class="section">
                <div class="section-title">
                    <span><i class="fas fa-bullseye"></i> –ê–∫—Ç–∏–≤–Ω—ã–µ —Ü–µ–ª–∏</span>
                </div>
                <div id="goalsList">
                    <div class="empty-state">
                        <i class="fas fa-bullseye"></i>
                        <div>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ü–µ–ª–µ–π</div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">
                    <span><i class="fas fa-trophy"></i> –î–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–µ —Ü–µ–ª–∏</span>
                </div>
                <div id="completedGoalsList">
                    <div class="empty-state">
                        <i class="fas fa-trophy"></i>
                        <div>–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã—Ö —Ü–µ–ª–µ–π</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ -->
        <div id="investmentsTab" class="tab-content">
            <button class="btn btn-investment" onclick="showInvestmentModal()">
                <i class="fas fa-plus"></i> –ù–æ–≤–∞—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è
            </button>
            
            <div class="section">
                <div class="section-title">
                    <span><i class="fas fa-chart-line"></i> –ü–æ—Ä—Ç—Ñ–µ–ª—å –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π</span>
                </div>
                <div id="investmentsList">
                    <div class="empty-state">
                        <i class="fas fa-chart-line"></i>
                        <div>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π</div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">
                    <span><i class="fas fa-lightbulb"></i> –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–µ –∏–¥–µ–∏</span>
                </div>
                <div id="investmentIdeas">
                    <div class="investment-card">
                        <div style="font-weight: 600; margin-bottom: 5px;">–ê–∫—Ü–∏–∏ –õ–£–ö–û–ô–õ</div>
                        <div style="font-size: 14px; margin-bottom: 10px;">–í—ã—Å–æ–∫–∏–µ –¥–∏–≤–∏–¥–µ–Ω–¥—ã, —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Ä–æ—Å—Ç</div>
                        <div class="investment-performance">
                            <div style="font-size: 12px; color: #666;">–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å: ~15% –≥–æ–¥–æ–≤—ã—Ö</div>
                        </div>
                    </div>
                    <div class="investment-card">
                        <div style="font-weight: 600; margin-bottom: 5px;">–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞ TON</div>
                        <div style="font-size: 14px; margin-bottom: 10px;">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram, –≤—ã—Å–æ–∫–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª</div>
                        <div class="investment-performance">
                            <div style="font-size: 12px; color: #666;">–í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å: –≤—ã—Å–æ–∫–∞—è</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
        <div id="profileTab" class="tab-content">
            <div class="section">
                <div class="section-title">
                    <span><i class="fas fa-user"></i> –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</span>
                </div>
                <div id="profileInfo">
                    <div class="empty-state">
                        <i class="fas fa-user"></i>
                        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è...</div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">
                    <span><i class="fas fa-file-alt"></i> –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</span>
                </div>
                <div class="report-options">
                    <div class="report-option" onclick="generateReport('monthly')">
                        <i class="fas fa-calendar"></i>
                        <div>–ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á–µ—Ç</div>
                    </div>
                    <div class="report-option" onclick="generateReport('yearly')">
                        <i class="fas fa-chart-bar"></i>
                        <div>–ì–æ–¥–æ–≤–æ–π –æ—Ç—á–µ—Ç</div>
                    </div>
                    <div class="report-option" onclick="exportToCSV()">
                        <i class="fas fa-file-csv"></i>
                        <div>CSV —ç–∫—Å–ø–æ—Ä—Ç</div>
                    </div>
                    <div class="report-option" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i>
                        <div>Excel —ç–∫—Å–ø–æ—Ä—Ç</div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">
                    <span><i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn btn-primary" onclick="showReferralModal()">
                        <i class="fas fa-user-plus"></i> –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞
                    </button>
                    <button class="btn" onclick="clearAllData()">
                        <i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
                    </button>
                    <button class="btn" onclick="resetHiddenCategories()">
                        <i class="fas fa-eye"></i> –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="nav-tabs">
        <div class="nav-tab active" onclick="switchTab('dashboard')">
            <i class="fas fa-home"></i>
            <span>–ì–ª–∞–≤–Ω–∞—è</span>
        </div>
        <div class="nav-tab" onclick="switchTab('transactions')">
            <i class="fas fa-exchange-alt"></i>
            <span>–û–ø–µ—Ä–∞—Ü–∏–∏</span>
        </div>
        <div class="nav-tab" onclick="switchTab('goals')">
            <i class="fas fa-bullseye"></i>
            <span>–¶–µ–ª–∏</span>
        </div>
        <div class="nav-tab" onclick="switchTab('investments')">
            <i class="fas fa-chart-line"></i>
            <span>–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</span>
        </div>
        <div class="nav-tab" onclick="switchTab('profile')">
            <i class="fas fa-user"></i>
            <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥</h2>
            
            <div class="form-group">
                <label class="form-label">–°—É–º–º–∞ (‚ÇΩ)</label>
                <div class="formatted-input-container">
                    <span class="currency-symbol">‚ÇΩ</span>
                    <input type="text" id="amountInput" class="form-input formatted" placeholder="1 000" 
                           oninput="formatCurrencyInput(this)" onblur="validateCurrencyInput(this)"
                           inputmode="decimal" pattern="[0-9]*">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select id="categorySelect" class="form-input" onchange="handleCategorySelect()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                </select>
                <div id="customCategoryGroup" style="display: none; margin-top: 10px;">
                    <input type="text" id="customCategoryInput" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <input type="text" id="descriptionInput" class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ó–∞—Ä–ø–ª–∞—Ç–∞ –∑–∞ —è–Ω–≤–∞—Ä—å">
            </div>
            
            <div class="form-group">
                <label class="form-label">–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                <input type="text" id="tagsInput" class="form-input" placeholder="—Ä–∞–±–æ—Ç–∞, –∞–≤–∞–Ω—Å, —è–Ω–≤–∞—Ä—å">
            </div>
            
            <button class="btn btn-primary" onclick="submitTransaction()">
                <i class="fas fa-check"></i> –î–æ–±–∞–≤–∏—Ç—å
            </button>
            <button class="btn" onclick="closeModal()" style="margin-top: 10px;">
                <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
            </button>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
    <div id="editTransactionModal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</h2>
            
            <div class="form-group">
                <label class="form-label">–°—É–º–º–∞ (‚ÇΩ)</label>
                <div class="formatted-input-container">
                    <span class="currency-symbol">‚ÇΩ</span>
                    <input type="text" id="editAmountInput" class="form-input formatted" placeholder="1 000" 
                           oninput="formatCurrencyInput(this)" onblur="validateCurrencyInput(this)"
                           inputmode="decimal" pattern="[0-9]*">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select id="editCategorySelect" class="form-input">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">–¢–∏–ø</label>
                <select id="editTypeSelect" class="form-input">
                    <option value="income">–î–æ—Ö–æ–¥</option>
                    <option value="expense">–†–∞—Å—Ö–æ–¥</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <input type="text" id="editDescriptionInput" class="form-input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">
            </div>
            
            <div class="form-group">
                <label class="form-label">–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                <input type="text" id="editTagsInput" class="form-input" placeholder="—Ç–µ–≥–∏">
            </div>
            
            <input type="hidden" id="editTransactionId">
            
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="saveEditedTransaction()" style="flex: 2;">
                    <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button class="btn btn-danger" onclick="deleteTransaction()" style="flex: 1;">
                    <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                </button>
            </div>
            
            <button class="btn" onclick="closeEditModal()" style="margin-top: 10px;">
                <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
            </button>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª–∫–∞ —Ü–µ–ª–∏ -->
    <div id="goalModal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-bullseye"></i> –ù–æ–≤–∞—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Ü–µ–ª—å</h2>
            
            <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏</label>
                <input type="text" id="goalTitle" class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù–æ–≤–∞—è –º–∞—à–∏–Ω–∞">
            </div>
            
            <div class="form-group">
                <label class="form-label">–°—É–º–º–∞ —Ü–µ–ª–∏ (‚ÇΩ)</label>
                <div class="formatted-input-container">
                    <span class="currency-symbol">‚ÇΩ</span>
                    <input type="text" id="goalAmount" class="form-input formatted" placeholder="500 000" 
                           oninput="formatCurrencyInput(this)" onblur="validateCurrencyInput(this)"
                           inputmode="decimal" pattern="[0-9]*">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">–°—Ä–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</label>
                <input type="date" id="goalDeadline" class="form-input">
            </div>
            
            <div class="form-group">
                <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select id="goalCategory" class="form-input">
                    <option value="–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è">–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è</option>
                    <option value="–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</option>
                    <option value="–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ">–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ</option>
                    <option value="–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ">–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</option>
                    <option value="–∂–∏–ª—å–µ">–ñ–∏–ª—å–µ</option>
                    <option value="—Ç–µ—Ö–Ω–∏–∫–∞">–¢–µ—Ö–Ω–∏–∫–∞</option>
                    <option value="–∞–≤—Ç–æ–º–æ–±–∏–ª—å">–ê–≤—Ç–æ–º–æ–±–∏–ª—å</option>
                    <option value="–∑–¥–æ—Ä–æ–≤—å–µ">–ó–¥–æ—Ä–æ–≤—å–µ</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                <select id="goalPriority" class="form-input">
                    <option value="1">–í—ã—Å–æ–∫–∏–π</option>
                    <option value="2">–°—Ä–µ–¥–Ω–∏–π</option>
                    <option value="3">–ù–∏–∑–∫–∏–π</option>
                </select>
            </div>
            
            <button class="btn btn-goal" onclick="submitGoal()">
                <i class="fas fa-check"></i> –°–æ–∑–¥–∞—Ç—å —Ü–µ–ª—å
            </button>
            <button class="btn" onclick="closeModal()" style="margin-top: 10px;">
                <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
            </button>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–µ–ª–∏ -->
    <div id="editGoalModal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–ª—å</h2>
            
            <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏</label>
                <input type="text" id="editGoalTitle" class="form-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏">
            </div>
            
            <div class="form-group">
                <label class="form-label">–¢–µ–∫—É—â–∞—è —Å—É–º–º–∞ (‚ÇΩ)</label>
                <div class="formatted-input-container">
                    <span class="currency-symbol">‚ÇΩ</span>
                    <input type="text" id="editGoalCurrentAmount" class="form-input formatted" placeholder="0" 
                           oninput="formatCurrencyInput(this)" onblur="validateCurrencyInput(this)"
                           inputmode="decimal" pattern="[0-9]*">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">–¶–µ–ª–µ–≤–∞—è —Å—É–º–º–∞ (‚ÇΩ)</label>
                <div class="formatted-input-container">
                    <span class="currency-symbol">‚ÇΩ</span>
                    <input type="text" id="editGoalTargetAmount" class="form-input formatted" placeholder="500 000" 
                           oninput="formatCurrencyInput(this)" onblur="validateCurrencyInput(this)"
                           inputmode="decimal" pattern="[0-9]*">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">–°—Ä–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</label>
                <input type="date" id="editGoalDeadline" class="form-input">
            </div>
            
            <div class="form-group">
                <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select id="editGoalCategory" class="form-input">
                    <option value="–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è">–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è</option>
                    <option value="–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</option>
                    <option value="–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ">–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ</option>
                    <option value="–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ">–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</option>
                    <option value="–∂–∏–ª—å–µ">–ñ–∏–ª—å–µ</option>
                    <option value="—Ç–µ—Ö–Ω–∏–∫–∞">–¢–µ—Ö–Ω–∏–∫–∞</option>
                    <option value="–∞–≤—Ç–æ–º–æ–±–∏–ª—å">–ê–≤—Ç–æ–º–æ–±–∏–ª—å</option>
                    <option value="–∑–¥–æ—Ä–æ–≤—å–µ">–ó–¥–æ—Ä–æ–≤—å–µ</option>
                </select>
            </div>
            
            <input type="hidden" id="editGoalId">
            
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-goal" onclick="saveEditedGoal()" style="flex: 2;">
                    <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button class="btn btn-danger" onclick="deleteGoal()" style="flex: 1;">
                    <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                </button>
            </div>
            
            <button class="btn" onclick="closeEditGoalModal()" style="margin-top: 10px;">
                <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
            </button>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —Ü–µ–ª–∏ -->
    <div id="addToGoalModal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-plus-circle"></i> –ü–æ–ø–æ–ª–Ω–∏—Ç—å —Ü–µ–ª—å</h2>
            
            <div class="form-group">
                <label class="form-label">–°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è (‚ÇΩ)</label>
                <div class="formatted-input-container">
                    <span class="currency-symbol">‚ÇΩ</span>
                    <input type="text" id="addToGoalAmount" class="form-input formatted" placeholder="1 000" 
                           oninput="formatCurrencyInput(this)" onblur="validateCurrencyInput(this)"
                           inputmode="decimal" pattern="[0-9]*">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <input type="text" id="addToGoalComment" class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ó–∞—Ä–ø–ª–∞—Ç–∞ —è–Ω–≤–∞—Ä—å">
            </div>
            
            <input type="hidden" id="addToGoalId">
            
            <button class="btn btn-goal" onclick="processAddToGoal()">
                <i class="fas fa-check"></i> –ü–æ–ø–æ–ª–Ω–∏—Ç—å
            </button>
            <button class="btn" onclick="closeAddToGoalModal()" style="margin-top: 10px;">
                <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
            </button>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª–∫–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ -->
    <div id="investmentModal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-chart-line"></i> –ù–æ–≤–∞—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è</h2>
            
            <div class="form-group">
                <label class="form-label">–¢–∏–ø –∞–∫—Ç–∏–≤–∞</label>
                <select id="investmentType" class="form-input">
                    <option value="stock">–ê–∫—Ü–∏–∏</option>
                    <option value="crypto">–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞</option>
                    <option value="bond">–û–±–ª–∏–≥–∞—Ü–∏–∏</option>
                    <option value="real_estate">–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å</option>
                    <option value="other">–î—Ä—É–≥–æ–µ</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–∞</label>
                <input type="text" id="investmentName" class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –õ–£–ö–û–ô–õ –∏–ª–∏ Bitcoin">
            </div>
            
            <div class="form-group">
                <label class="form-label">–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É (‚ÇΩ)</label>
                <div class="input-group">
                    <div class="formatted-input-container" style="flex: 1;">
                        <span class="currency-symbol">‚ÇΩ</span>
                        <input type="text" id="investmentPrice" class="form-input formatted" placeholder="1 000" 
                               oninput="formatCurrencyInput(this); calculateInvestmentTotal();" 
                               onblur="validateCurrencyInput(this)" inputmode="decimal" pattern="[0-9]*">
                    </div>
                    <div class="unit">‚ÇΩ</div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                <div class="input-group">
                    <input type="number" id="investmentQuantity" class="form-input" placeholder="1" min="0.000001" step="0.000001" oninput="calculateInvestmentTotal()" inputmode="decimal">
                    <div class="unit">—à—Ç.</div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">–ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞ (‚ÇΩ)</label>
                <input type="text" id="investmentAmount" class="form-input formatted" placeholder="0" readonly style="background: var(--border-color);">
                <div style="font-size: 12px; color: var(--tg-theme-hint-color); margin-top: 5px;">
                    <i class="fas fa-calculator"></i> –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                </div>
            </div>
            
            <button class="btn btn-investment" onclick="submitInvestment()">
                <i class="fas fa-check"></i> –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—é
            </button>
            <button class="btn" onclick="closeModal()" style="margin-top: 10px;">
                <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
            </button>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ -->
    <div id="editInvestmentModal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—é</h2>
            
            <div class="form-group">
                <label class="form-label">–¢–∏–ø –∞–∫—Ç–∏–≤–∞</label>
                <select id="editInvestmentType" class="form-input">
                    <option value="stock">–ê–∫—Ü–∏–∏</option>
                    <option value="crypto">–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞</option>
                    <option value="bond">–û–±–ª–∏–≥–∞—Ü–∏–∏</option>
                    <option value="real_estate">–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å</option>
                    <option value="other">–î—Ä—É–≥–æ–µ</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–∞</label>
                <input type="text" id="editInvestmentName" class="form-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–∞">
            </div>
            
            <div class="form-group">
                <label class="form-label">–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É (‚ÇΩ)</label>
                <div class="input-group">
                    <div class="formatted-input-container" style="flex: 1;">
                        <span class="currency-symbol">‚ÇΩ</span>
                        <input type="text" id="editInvestmentPrice" class="form-input formatted" placeholder="1 000" 
                               oninput="formatCurrencyInput(this); calculateEditInvestmentTotal();" 
                               onblur="validateCurrencyInput(this)" inputmode="decimal" pattern="[0-9]*">
                    </div>
                    <div class="unit">‚ÇΩ</div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                <div class="input-group">
                    <input type="number" id="editInvestmentQuantity" class="form-input" placeholder="1" min="0.000001" step="0.000001" oninput="calculateEditInvestmentTotal()" inputmode="decimal">
                    <div class="unit">—à—Ç.</div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ (‚ÇΩ)</label>
                <div class="input-group">
                    <div class="formatted-input-container" style="flex: 1;">
                        <span class="currency-symbol">‚ÇΩ</span>
                        <input type="text" id="editInvestmentCurrentPrice" class="form-input formatted" placeholder="1 000" 
                               oninput="formatCurrencyInput(this); calculateEditInvestmentProfit();" 
                               onblur="validateCurrencyInput(this)" inputmode="decimal" pattern="[0-9]*">
                    </div>
                    <div class="unit">‚ÇΩ</div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">–ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞ (‚ÇΩ)</label>
                <input type="text" id="editInvestmentAmount" class="form-input formatted" placeholder="0" readonly style="background: var(--border-color);">
            </div>
            
            <div class="form-group">
                <label class="form-label">–¢–µ–∫—É—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)</label>
                <input type="text" id="editInvestmentCurrentValue" class="form-input formatted" placeholder="0" readonly style="background: var(--border-color);">
            </div>
            
            <div class="form-group">
                <label class="form-label">–ü—Ä–∏–±—ã–ª—å/—É–±—ã—Ç–æ–∫</label>
                <input type="text" id="editInvestmentProfit" class="form-input formatted" placeholder="0" readonly style="background: var(--border-color);">
            </div>
            
            <input type="hidden" id="editInvestmentId">
            
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-investment" onclick="saveEditedInvestment()" style="flex: 2;">
                    <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button class="btn btn-danger" onclick="deleteInvestment()" style="flex: 1;">
                    <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                </button>
            </div>
            
            <button class="btn" onclick="closeEditInvestmentModal()" style="margin-top: 10px;">
                <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
            </button>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã -->
    <div id="referralModal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-users"></i> –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</h2>
            
            <div class="form-group">
                <p style="margin-bottom: 15px; color: var(--text-color); opacity: 0.8;">
                    –ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –±–æ–Ω—É—Å—ã –∑–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω–æ–≥–æ!
                </p>
            </div>
            
            <div class="form-group">
                <label class="form-label">–í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞</label>
                <div class="referral-link">
                    <input type="text" id="referralLinkInput" readonly value="–ó–∞–≥—Ä—É–∑–∫–∞...">
                    <button class="copy-btn" onclick="copyReferralLink()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</label>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <div style="background: var(--card-bg); padding: 12px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 12px; color: var(--text-color); opacity: 0.7;">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ</div>
                        <div style="font-weight: 600; font-size: 18px;" id="referralCountModal">0</div>
                    </div>
                    <div style="background: var(--card-bg); padding: 12px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 12px; color: var(--text-color); opacity: 0.7;">–ë–æ–Ω—É—Å—ã</div>
                        <div style="font-weight: 600; font-size: 18px;" id="referralBonusModal">0 ‚ÇΩ</div>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="closeReferralModal()">
                <i class="fas fa-check"></i> –ü–æ–Ω—è—Ç–Ω–æ
            </button>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ —Ü–µ–ª—è–º -->
    <div id="goalAllocationModal" class="modal"></div>
    
    <!-- –ú–æ–¥–∞–ª–∫–∞ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ -->
    <div id="expenseDetailsModal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-list"></i> –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤</h2>
            <div style="margin-bottom: 20px; font-size: 14px; color: var(--text-color); opacity: 0.8;">
                –ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü
            </div>
            
            <div id="expenseDetailsList" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                <!-- –°–ø–∏—Å–æ–∫ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∑–¥–µ—Å—å -->
            </div>
            
            <div style="background: var(--card-bg); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span style="font-weight: 600;">–í—Å–µ–≥–æ —Ä–∞—Å—Ö–æ–¥–æ–≤:</span>
                    <span style="color: var(--expense-color); font-weight: 600;" id="totalExpensesModal">0 ‚ÇΩ</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="font-weight: 600;">–î–æ–ª—è –æ—Ç –¥–æ—Ö–æ–¥–æ–≤:</span>
                    <span style="font-weight: 600;" id="expensePercentageModal">0%</span>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="closeExpenseDetails()">
                <i class="fas fa-check"></i> –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
    </div>
    
    <!-- –ó–∞–≥—Ä—É–∑—á–∏–∫ -->
    <div id="loader" class="loader hidden"></div>
    
    <script>
        // Telegram Web App
        let tg = window.Telegram.WebApp;
        let userId = null;
        let currentTransactionType = 'income';
        let selectedCategory = '';
        let charts = {};
        let dashboardData = null;
        
        // –ù–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
        let hiddenCategories = [];
        let monthlyMemory = {};
        let linearChart = null;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        tg.expand();
        tg.ready();
        tg.setHeaderColor('secondary_bg_color');
        tg.setBackgroundColor('secondary_bg_color');
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
        const initData = tg.initDataUnsafe;
        if (initData.user) {
            userId = initData.user.id;
            document.title = `–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¢—Ä–µ–∫–µ—Ä | ${initData.user.first_name}`;
        } else {
            userId = 'test_user_' + Date.now();
            localStorage.setItem('telegram_user_id', userId);
            localStorage.setItem('test_user_name', '–¢–µ—Å—Ç–æ–≤—ã–π –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ localStorage
        initUserData();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∫—Ä—ã—Ç—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –ø–∞–º—è—Ç—å
        loadHiddenCategories();
        loadMonthlyMemory();
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
        const now = new Date();
        const options = { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        };
        document.getElementById('currentDate').textContent = 
            now.toLocaleDateString('ru-RU', options);
        
        // ====================== –ù–û–í–´–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ ======================
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        function showWelcomeMessage() {
            const data = getUserData();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ –ª–∏ —É–∂–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
            if (!localStorage.getItem(`welcome_shown_${userId}`)) {
                setTimeout(() => {
                    const welcomeMessage = `
                        <div class="success-message" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <i class="fas fa-heart"></i> –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¢—Ä–µ–∫–µ—Ä!
                            <div style="font-size: 12px; margin-top: 5px; opacity: 0.9;">
                                –£–ø—Ä–∞–≤–ª—è–π—Ç–µ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏, —Å—Ç–∞–≤—å—Ç–µ —Ü–µ–ª–∏ –∏ –ø–æ–ª—É—á–∞–π—Ç–µ —Å–æ–≤–µ—Ç—ã
                            </div>
                        </div>
                    `;
                    
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = welcomeMessage;
                    document.body.appendChild(tempDiv.firstChild);
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ–∫–∞–∑–∞–Ω–æ
                    localStorage.setItem(`welcome_shown_${userId}`, 'true');
                    
                    // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                    setTimeout(() => {
                        const welcomeMsg = document.querySelector('.success-message');
                        if (welcomeMsg) welcomeMsg.remove();
                    }, 5000);
                }, 1000);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–≤–µ—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è
        function updateSmartAdvice(summary) {
            const data = getUserData();
            const advice = [];
            
            // –ê–Ω–∞–ª–∏–∑ —Ä–∞—Å—Ö–æ–¥–æ–≤
            if (summary.expense_structure && summary.expense_structure.length > 0) {
                const topExpense = summary.expense_structure[0];
                
                if (topExpense.percentage > 40) {
                    advice.push({
                        advice_text: `‚ö†Ô∏è "${topExpense.category}" –∑–∞–Ω–∏–º–∞–µ—Ç ${topExpense.percentage.toFixed(1)}% —Ä–∞—Å—Ö–æ–¥–æ–≤. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Å–æ–∫—Ä–∞—Ç–∏—Ç—å —Ç—Ä–∞—Ç—ã –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.`,
                        priority: 1
                    });
                }
                
                if (summary.summary.total_expenses > summary.summary.total_income * 0.9) {
                    advice.push({
                        advice_text: 'üö® –†–∞—Å—Ö–æ–¥—ã –ø—Ä–µ–≤—ã—à–∞—é—Ç 90% –¥–æ—Ö–æ–¥–æ–≤! –°—Ä–æ—á–Ω–æ –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–∏—Ç–µ –±—é–¥–∂–µ—Ç.',
                        priority: 1
                    });
                }
            }
            
            // –ê–Ω–∞–ª–∏–∑ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π
            if (data.user.balance > 50000 && data.investments.length === 0) {
                advice.push({
                    advice_text: 'üí∞ –ù–∞ —Å—á–µ—Ç—É –±–æ–ª–µ–µ 50 000 ‚ÇΩ. –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∏–Ω—Ñ–ª—è—Ü–∏–∏.',
                    priority: 2
                });
            }
            
            // –ê–Ω–∞–ª–∏–∑ –¥–æ—Ö–æ–¥–æ–≤
            if (summary.summary.total_income > 0 && summary.summary.savings_rate < 10) {
                advice.push({
                    advice_text: 'üéØ –û—Ç–∫–ª–∞–¥—ã–≤–∞–π—Ç–µ –º–∏–Ω–∏–º—É–º 10% –æ—Ç –¥–æ—Ö–æ–¥–æ–≤ –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏.',
                    priority: 2
                });
            }
            
            // –ê–Ω–∞–ª–∏–∑ —Ü–µ–ª–µ–π
            const activeGoals = data.goals.filter(g => !g.completed);
            if (activeGoals.length === 0) {
                advice.push({
                    advice_text: 'üéØ –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é —Ü–µ–ª—å –¥–ª—è –º–æ—Ç–∏–≤–∞—Ü–∏–∏ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.',
                    priority: 3
                });
            } else {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ü–µ–ª–∏ —Å –∏—Å—Ç–µ–∫—à–∏–º —Å—Ä–æ–∫–æ–º
                const overdueGoals = activeGoals.filter(goal => {
                    const deadline = new Date(goal.deadline);
                    return deadline < new Date() && goal.current_amount < goal.target_amount;
                });
                
                if (overdueGoals.length > 0) {
                    advice.push({
                        advice_text: `‚è∞ –£ –≤–∞—Å ${overdueGoals.length} —Ü–µ–ª—å(-–µ–π) —Å –∏—Å—Ç–µ–∫—à–∏–º —Å—Ä–æ–∫–æ–º. –ü–µ—Ä–µ—Å–º–æ—Ç—Ä–∏—Ç–µ —Å—Ä–æ–∫–∏ –∏–ª–∏ —É–≤–µ–ª–∏—á—å—Ç–µ –≤–∑–Ω–æ—Å—ã.`,
                        priority: 1
                    });
                }
            }
            
            // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–æ–≤–µ—Ç—ã (–µ—Å–ª–∏ –º–∞–ª–æ)
            if (advice.length < 3) {
                advice.push(
                    {
                        advice_text: 'üìä –†–µ–≥—É–ª—è—Ä–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ—Ç—á–µ—Ç—ã –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤.',
                        priority: 3
                    },
                    {
                        advice_text: 'üèÜ –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –æ—Ç–º–µ—á–∞—Ç—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–µ —Ü–µ–ª–∏!',
                        priority: 3
                    },
                    {
                        advice_text: 'üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–≥–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π.',
                        priority: 3
                    }
                );
            }
            
            return advice.slice(0, 5); // –ù–µ –±–æ–ª–µ–µ 5 —Å–æ–≤–µ—Ç–æ–≤
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ –ø–æ —Ä–∞—Å—Ö–æ–¥–∞–º
        function showExpenseDetails() {
            const summary = getFinancialSummary('month');
            const modal = document.getElementById('expenseDetailsModal');
            const list = document.getElementById('expenseDetailsList');
            
            list.innerHTML = generateExpenseDetailsHTML(summary.expense_structure);
            
            document.getElementById('totalExpensesModal').textContent = 
                `${formatCurrency(summary.summary.total_expenses)} ‚ÇΩ`;
            
            const expensePercentage = summary.summary.total_income > 0 ? 
                (summary.summary.total_expenses / summary.summary.total_income * 100) : 0;
            document.getElementById('expensePercentageModal').textContent = 
                `${expensePercentage.toFixed(1)}%`;
            
            modal.style.display = 'block';
        }
        
        function generateExpenseDetailsHTML(expenseStructure) {
            if (!expenseStructure || expenseStructure.length === 0) {
                return '<div class="empty-state" style="padding: 20px;"><i class="fas fa-chart-pie"></i><div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å—Ö–æ–¥–∞—Ö</div></div>';
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            
            expenseStructure.forEach((item, index) => {
                const isHidden = hiddenCategories.includes(item.category);
                const color = getCategoryColor(index);
                
                html += `
                    <div class="expense-detail-item" 
                         style="border-left-color: ${color}; ${isHidden ? 'opacity: 0.5;' : ''}">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 5px; display: flex; align-items: center; gap: 8px;">
                                <div style="width: 12px; height: 12px; border-radius: 50%; background: ${color};"></div>
                                ${item.category}
                            </div>
                            <div style="font-size: 12px; color: var(--text-color); opacity: 0.7;">
                                ${item.percentage.toFixed(1)}% –æ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600; color: var(--expense-color);">
                                ${formatCurrency(item.amount)} ‚ÇΩ
                            </div>
                            <button class="category-visibility-btn" onclick="toggleCategoryVisibility('${item.category}', event)" 
                                    style="opacity: ${isHidden ? 0.7 : 1}; margin-top: 5px;">
                                <i class="fas fa-eye${isHidden ? '-slash' : ''}"></i>
                                ${isHidden ? '–ü–æ–∫–∞–∑–∞—Ç—å' : '–°–∫—Ä—ã—Ç—å'}
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }
        
        function getCategoryColor(index) {
            const colors = ['#FF6B6B', '#4ECDC4', '#FFD166', '#06D6A0', '#118AB2', '#EF476F', '#073B4C', '#7209B7'];
            return colors[index % colors.length];
        }
        
        function toggleCategoryVisibility(category, event) {
            if (event) event.stopPropagation();
            
            if (hiddenCategories.includes(category)) {
                hiddenCategories = hiddenCategories.filter(c => c !== category);
            } else {
                hiddenCategories.push(category);
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            saveHiddenCategories();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∏–∞–≥—Ä–∞–º–º—É
            updateDashboard();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            const detailsList = document.getElementById('expenseDetailsList');
            if (detailsList) {
                const summary = getFinancialSummary('month');
                detailsList.innerHTML = generateExpenseDetailsHTML(summary.expense_structure);
            }
        }
        
        function saveHiddenCategories() {
            const userDataKey = `hidden_categories_${userId}`;
            localStorage.setItem(userDataKey, JSON.stringify(hiddenCategories));
        }
        
        function loadHiddenCategories() {
            const userDataKey = `hidden_categories_${userId}`;
            const saved = localStorage.getItem(userDataKey);
            hiddenCategories = saved ? JSON.parse(saved) : [];
        }
        
        function resetHiddenCategories() {
            hiddenCategories = [];
            saveHiddenCategories();
            updateDashboard();
            showSuccessNotification('–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞–∑–∞–Ω—ã!');
        }
        
        function closeExpenseDetails() {
            document.getElementById('expenseDetailsModal').style.display = 'none';
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–∏–Ω–µ–π–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ –¥–∏–Ω–∞–º–∏–∫–∏
        function createLinearChart() {
            const ctx = document.getElementById('linearChart').getContext('2d');
            
            const data = getUserData();
            const now = new Date();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            
            // –ì–æ—Ç–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
            const dailyData = {
                income: new Array(daysInMonth).fill(0),
                expense: new Array(daysInMonth).fill(0),
                labels: []
            };
            
            for (let i = 0; i < daysInMonth; i++) {
                const date = new Date(now.getFullYear(), now.getMonth(), i + 1);
                dailyData.labels.push(`${i + 1} ${date.toLocaleDateString('ru-RU', { month: 'short' })}`);
            }
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
            data.transactions.forEach(transaction => {
                const date = new Date(transaction.date);
                if (date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear()) {
                    const dayIndex = date.getDate() - 1;
                    if (transaction.type === 'income') {
                        dailyData.income[dayIndex] += transaction.amount;
                    } else {
                        dailyData.expense[dayIndex] += transaction.amount;
                    }
                }
            });
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ —Å—É–º–º—ã
            const cumulativeIncome = [];
            const cumulativeExpense = [];
            let incomeSum = 0;
            let expenseSum = 0;
            
            for (let i = 0; i < daysInMonth; i++) {
                incomeSum += dailyData.income[i];
                expenseSum += dailyData.expense[i];
                cumulativeIncome.push(incomeSum);
                cumulativeExpense.push(expenseSum);
            }
            
            if (linearChart) {
                linearChart.destroy();
            }
            
            linearChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dailyData.labels,
                    datasets: [
                        {
                            label: '–î–æ—Ö–æ–¥—ã',
                            data: cumulativeIncome,
                            borderColor: 'var(--income-color)',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: '–†–∞—Å—Ö–æ–¥—ã',
                            data: cumulativeExpense,
                            borderColor: 'var(--expense-color)',
                            backgroundColor: 'rgba(244, 67, 54, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: function() { return getTextColor(); }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatCurrency(context.raw)} ‚ÇΩ`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            },
                            ticks: {
                                color: function() { return getTextColor(); },
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            },
                            ticks: {
                                color: function() { return getTextColor(); },
                                callback: function(value) {
                                    return formatCurrency(value) + ' ‚ÇΩ';
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'nearest'
                    }
                }
            });
        }
        
        function updateLinearChart() {
            createLinearChart();
            showSuccessNotification('–î–∏–Ω–∞–º–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ—Å—è—á–Ω–æ–π –ø–∞–º—è—Ç–∏
        function updateMonthlyMemory() {
            const data = getUserData();
            const now = new Date();
            const monthKey = `${now.getFullYear()}-${now.getMonth()}`;
            
            if (!monthlyMemory[monthKey]) {
                monthlyMemory[monthKey] = {
                    startBalance: data.user.balance,
                    dailyBalances: {},
                    lastUpdate: now.toISOString()
                };
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–∞–ª–∞–Ω—Å
            const todayKey = now.toISOString().split('T')[0];
            monthlyMemory[monthKey].dailyBalances[todayKey] = data.user.balance;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            localStorage.setItem(`monthly_memory_${userId}`, JSON.stringify(monthlyMemory));
        }
        
        function loadMonthlyMemory() {
            const saved = localStorage.getItem(`monthly_memory_${userId}`);
            monthlyMemory = saved ? JSON.parse(saved) : {};
        }
        
        function getBalanceChangeFromYesterday() {
            const now = new Date();
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            
            const todayKey = now.toISOString().split('T')[0];
            const yesterdayKey = yesterday.toISOString().split('T')[0];
            
            const monthKey = `${now.getFullYear()}-${now.getMonth()}`;
            
            if (monthlyMemory[monthKey] && monthlyMemory[monthKey].dailyBalances[yesterdayKey]) {
                const todayBalance = monthlyMemory[monthKey].dailyBalances[todayKey] || getUserData().user.balance;
                const yesterdayBalance = monthlyMemory[monthKey].dailyBalances[yesterdayKey];
                
                return {
                    amount: todayBalance - yesterdayBalance,
                    percent: yesterdayBalance > 0 ? ((todayBalance - yesterdayBalance) / yesterdayBalance) * 100 : 0
                };
            }
            
            return { amount: 0, percent: 0 };
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Å–∫—Ä—ã—Ç–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        function updateExpenseChartEnhanced(expenseStructure) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–∫—Ä—ã—Ç—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            const filteredStructure = expenseStructure.filter(item => !hiddenCategories.includes(item.category));
            
            if (charts.expenseChart) {
                charts.expenseChart.destroy();
            }
            
            if (!filteredStructure || filteredStructure.length === 0) {
                charts.expenseChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'],
                        datasets: [{
                            data: [1],
                            backgroundColor: ['#e0e0e0'],
                            borderWidth: 2,
                            borderColor: 'var(--bg-color)'
                        }]
                    },
                    options: getChartOptions([])
                });
                return;
            }
            
            const labels = filteredStructure.map(item => item.category);
            const data = filteredStructure.map(item => item.amount);
            const percentages = filteredStructure.map(item => item.percentage);
            
            const colors = [
                '#FF9AA2', '#FFB7B2', '#FFDAC1', '#E2F0CB',
                '#B5EAD7', '#C7CEEA', '#D8E2DC', '#FFE5D9',
                '#FFD6E0', '#C9E4DE'
            ];
            
            charts.expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: 'var(--bg-color)'
                    }]
                },
                options: getChartOptions(percentages)
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞
            const canvas = document.getElementById('expenseChart');
            canvas.addEventListener('dblclick', function(event) {
                const points = charts.expenseChart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                if (points.length > 0) {
                    const index = points[0].index;
                    const category = labels[index];
                    toggleCategoryVisibility(category, event);
                }
            });
        }
        
        function getChartOptions(percentages) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: function() { return getTextColor(); },
                            font: { size: 12 },
                            padding: 20,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const percentage = percentages[context.dataIndex] || 0;
                                return `${label}: ${formatCurrency(value)} ‚ÇΩ (${percentage.toFixed(1)}%)`;
                            }
                        }
                    }
                },
                cutout: '60%'
            };
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏ —Ü–µ–ª–∏ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
        function submitGoalEnhanced() {
            const title = document.getElementById('goalTitle').value.trim();
            const amount = parseCurrency(document.getElementById('goalAmount').value);
            const deadline = document.getElementById('goalDeadline').value;
            const category = document.getElementById('goalCategory').value;
            const priority = document.getElementById('goalPriority').value;
            
            if (!title) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏');
                return;
            }
            
            if (!amount || amount <= 0) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
                return;
            }
            
            const goal = addGoal({
                user_id: userId,
                title: title,
                target_amount: amount,
                deadline: deadline,
                category: category,
                priority: parseInt(priority)
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —É—Å–ø–µ—Ö–∞
            const modal = document.getElementById('goalModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div style="text-align: center; padding: 30px;">
                    <div style="font-size: 48px; color: #4CAF50; margin-bottom: 20px;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h2 style="margin-bottom: 10px; color: var(--text-color);">–¶–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞!</h2>
                    <p style="color: var(--text-color); opacity: 0.8; margin-bottom: 30px;">
                        "${title}"<br>
                        –¶–µ–ª—å: ${formatCurrency(amount)} ‚ÇΩ
                    </p>
                    <div style="font-size: 14px; color: var(--text-color); opacity: 0.6;">
                        –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–∫—Ä–æ–µ—Ç—Å—è —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã...
                    </div>
                </div>
            `;
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                closeModal();
                loadGoals();
                showSuccessNotification('–¶–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!');
            }, 2000);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ü–µ–ª–µ–π
        function checkAndMoveCompletedGoals() {
            const data = getUserData();
            const now = new Date();
            let movedCount = 0;
            
            data.goals.forEach(goal => {
                if (!goal.completed && goal.current_amount >= goal.target_amount) {
                    goal.completed = true;
                    goal.completed_at = now.toISOString();
                    movedCount++;
                }
            });
            
            if (movedCount > 0) {
                saveUserData(data);
            }
        }
        
        // ====================== –û–°–ù–û–í–ù–û–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ ======================
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é updateDashboard
        function updateDashboardEnhanced() {
            const data = getUserData();
            const summary = getFinancialSummary('month');
            const healthScore = getFinancialHealthScore(summary);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
            document.getElementById('balanceAmount').textContent = 
                `${formatCurrency(data.user.balance)} ‚ÇΩ`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            document.getElementById('incomeValue').textContent = 
                `${formatCurrency(summary.summary.total_income)} ‚ÇΩ`;
            document.getElementById('expenseValue').textContent = 
                `${formatCurrency(summary.summary.total_expenses)} ‚ÇΩ`;
            document.getElementById('savingsValue').textContent = 
                `${summary.summary.savings_rate.toFixed(1)}%`;
            document.getElementById('investmentValue').textContent = 
                `${formatCurrency(summary.summary.total_investments)} ‚ÇΩ`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
            document.getElementById('incomeCount').textContent = 
                `${data.transactions.filter(t => t.type === 'income').length} –æ–ø–µ—Ä–∞—Ü–∏–π`;
            document.getElementById('expenseCount').textContent = 
                `${data.transactions.filter(t => t.type === 'expense').length} –æ–ø–µ—Ä–∞—Ü–∏–π`;
            document.getElementById('investmentCount').textContent = 
                `${data.investments.length} –∞–∫—Ç–∏–≤–æ–≤`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
            const balanceChange = summary.summary.net_income;
            const changeElement = document.getElementById('balanceChange');
            changeElement.textContent = 
                `${balanceChange >= 0 ? '+' : ''}${formatCurrency(balanceChange)} ‚ÇΩ –∑–∞ –º–µ—Å—è—Ü`;
            changeElement.style.color = balanceChange >= 0 ? '#4CAF50' : '#f44336';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞ –≤—á–µ—Ä–∞
            const yesterdayChange = getBalanceChangeFromYesterday();
            const yesterdayElement = document.getElementById('balanceYesterday');
            if (yesterdayElement) {
                yesterdayElement.innerHTML = `
                    <i class="fas fa-calendar-day"></i> –° –≤—á–µ—Ä–∞: 
                    <span style="color: ${yesterdayChange.amount >= 0 ? '#4CAF50' : '#f44336'}; font-weight: 600;">
                        ${yesterdayChange.amount >= 0 ? '+' : ''}${formatCurrency(yesterdayChange.amount)} ‚ÇΩ
                        (${yesterdayChange.percent >= 0 ? '+' : ''}${yesterdayChange.percent.toFixed(1)}%)
                    </span>
                `;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ
            updateHealthScore(healthScore);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
            updateExpenseChartEnhanced(summary.expense_structure);
            createLinearChart();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ —Å–æ–≤–µ—Ç—ã
            updateRecentTransactions(summary.recent_transactions);
            updateAdvice(updateSmartAdvice(summary));
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ü–µ–ª–∏
            checkAndMoveCompletedGoals();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            document.getElementById('lastUpdate').textContent = 
                `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'})}`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Å—è—á–Ω—É—é –ø–∞–º—è—Ç—å
            updateMonthlyMemory();
        }
        
        function updateHealthScore(healthScore) {
            const scoreElement = document.getElementById('healthScore');
            const fillElement = document.getElementById('healthFill');
            const statusElement = document.getElementById('healthStatus');
            
            scoreElement.textContent = Math.round(healthScore);
            fillElement.style.width = `${healthScore}%`;
            
            let statusText = '';
            let healthClass = '';
            
            if (healthScore >= 80) {
                statusText = '–û—Ç–ª–∏—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ';
                healthClass = 'excellent';
            } else if (healthScore >= 60) {
                statusText = '–•–æ—Ä–æ—à–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ';
                healthClass = 'good';
            } else {
                statusText = '–¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è';
                healthClass = 'poor';
            }
            
            scoreElement.className = `health-score ${healthClass}`;
            fillElement.className = `health-fill ${healthClass}`;
            statusElement.textContent = statusText;
        }
        
        // ====================== –£–¢–ò–õ–ò–¢–´ –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø ======================
        
        function formatCurrency(value) {
            return new Intl.NumberFormat('ru-RU', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }
        
        function parseCurrency(value) {
            if (!value) return 0;
            return parseFloat(value.toString().replace(/\s/g, '').replace(',', '.'));
        }
        
        function formatCurrencyInput(input) {
            let value = input.value.replace(/\D/g, '');
            if (value === '') {
                input.value = '';
                return;
            }
            
            let num = parseInt(value, 10);
            if (isNaN(num)) num = 0;
            
            input.value = formatCurrency(num);
            
            // –í—ã–∑—ã–≤–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã
            if (input.id === 'investmentPrice' || input.id === 'editInvestmentPrice' || 
                input.id === 'editInvestmentCurrentPrice') {
                calculateInvestmentTotal();
            }
        }
        
        function validateCurrencyInput(input) {
            let value = parseCurrency(input.value);
            if (value <= 0) {
                input.value = '';
            } else {
                input.value = formatCurrency(value);
            }
        }
        
        // ====================== –§–£–ù–ö–¶–ò–ò LOCALSTORAGE ======================
        
        function initUserData() {
            const userDataKey = `finance_user_${userId}`;
            
            if (!localStorage.getItem(userDataKey)) {
                const initialData = {
                    user: {
                        user_id: userId,
                        username: initData.user?.username || 'test_user',
                        full_name: initData.user?.first_name || '–¢–µ—Å—Ç–æ–≤—ã–π –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                        registration_date: new Date().toISOString(),
                        balance: 0,
                        profession: '',
                        main_income: 0,
                        currency: '‚ÇΩ',
                        referral_code: generateReferralCode(),
                        referred_by: null,
                        referral_count: 0,
                        referral_bonus: 0
                    },
                    transactions: [],
                    goals: [],
                    investments: [],
                    categories: [
                        { user_id: userId, name: '–∑–∞—Ä–ø–ª–∞—Ç–∞', type: 'income', color: '#4CAF50', icon: 'üí∞' },
                        { user_id: userId, name: '–ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞', type: 'income', color: '#2196F3', icon: 'üíº' },
                        { user_id: userId, name: '–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏', type: 'income', color: '#9C27B0', icon: 'üìà' },
                        { user_id: userId, name: '–ø–æ–¥–∞—Ä–∫–∏', type: 'income', color: '#FF9800', icon: 'üéÅ' },
                        { user_id: userId, name: '–¥–∏–≤–∏–¥–µ–Ω–¥—ã', type: 'income', color: '#795548', icon: 'üíπ' },
                        { user_id: userId, name: '–∞—Ä–µ–Ω–¥–∞', type: 'income', color: '#607D8B', icon: 'üè†' },
                        { user_id: userId, name: '–µ–¥–∞', type: 'expense', color: '#F44336', icon: 'üçî' },
                        { user_id: userId, name: '—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç', type: 'expense', color: '#3F51B5', icon: 'üöó' },
                        { user_id: userId, name: '–∂–∏–ª—å–µ', type: 'expense', color: '#795548', icon: 'üè†' },
                        { user_id: userId, name: '—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è', type: 'expense', color: '#E91E63', icon: 'üéÆ' },
                        { user_id: userId, name: '–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ', type: 'expense', color: '#009688', icon: 'üìö' },
                        { user_id: userId, name: '–∑–¥–æ—Ä–æ–≤—å–µ', type: 'expense', color: '#00BCD4', icon: 'üè•' },
                        { user_id: userId, name: '–æ–¥–µ–∂–¥–∞', type: 'expense', color: '#FF5722', icon: 'üëï' },
                        { user_id: userId, name: '—Ç–µ—Ö–Ω–∏–∫–∞', type: 'expense', color: '#9C27B0', icon: 'üíª' },
                        { user_id: userId, name: '–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è', type: 'expense', color: '#8BC34A', icon: '‚úàÔ∏è' },
                        { user_id: userId, name: '–ø–æ–¥–∞—Ä–∫–∏', type: 'expense', color: '#FF9800', icon: 'üéÅ' },
                        { user_id: userId, name: '–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏', type: 'expense', color: '#FFC107', icon: 'üìä' },
                        { user_id: userId, name: '–¥—Ä—É–≥–æ–µ', type: 'income', color: '#757575', icon: 'üìå' },
                        { user_id: userId, name: '–¥—Ä—É–≥–æ–µ', type: 'expense', color: '#757575', icon: 'üìå' }
                    ]
                };
                
                localStorage.setItem(userDataKey, JSON.stringify(initialData));
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
            updateReferralModal();
        }
        
        function getUserData() {
            const userDataKey = `finance_user_${userId}`;
            const data = JSON.parse(localStorage.getItem(userDataKey)) || {};
            if (!data.transactions) data.transactions = [];
            if (!data.goals) data.goals = [];
            if (!data.investments) data.investments = [];
            if (!data.user) data.user = { balance: 0 };
            if (!data.categories) data.categories = [];
            if (!data.user.referral_code) data.user.referral_code = generateReferralCode();
            if (!data.user.referral_count) data.user.referral_count = 0;
            if (!data.user.referral_bonus) data.user.referral_bonus = 0;
            return data;
        }
        
        function saveUserData(data) {
            const userDataKey = `finance_user_${userId}`;
            localStorage.setItem(userDataKey, JSON.stringify(data));
        }
        
        function generateReferralCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }
        
        function updateReferralModal() {
            const data = getUserData();
            const referralLink = `https://t.me/your_bot_username?start=ref_${data.user.referral_code}`;
            document.getElementById('referralLinkInput').value = referralLink;
            document.getElementById('referralCountModal').textContent = data.user.referral_count;
            document.getElementById('referralBonusModal').textContent = formatCurrency(data.user.referral_bonus) + ' ‚ÇΩ';
        }
        
        // ====================== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ======================
        
        function showSuccessNotification(message) {
            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
            const existingNotification = document.querySelector('.success-message');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const notification = document.createElement('div');
            notification.className = 'success-message';
            notification.innerHTML = `
                <i class="fas fa-check-circle success-check"></i> ${message}
            `;
            
            document.body.appendChild(notification);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }
        
        // ====================== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ======================
        
        function addTransaction(transaction) {
            const data = getUserData();
            transaction.id = data.transactions.length ? Math.max(...data.transactions.map(t => t.id)) + 1 : 1;
            transaction.date = new Date().toISOString();
            data.transactions.unshift(transaction);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
            if (transaction.type === 'income') {
                data.user.balance += transaction.amount;
            } else {
                data.user.balance -= transaction.amount;
            }
            
            saveUserData(data);
            
            // –ï—Å–ª–∏ —ç—Ç–æ –¥–æ—Ö–æ–¥ –∏ –µ—Å—Ç—å —Ü–µ–ª–∏, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å
            if (transaction.type === 'income') {
                const activeGoals = data.goals.filter(g => !g.completed);
                if (activeGoals.length > 0) {
                    setTimeout(() => {
                        showGoalAllocationModal(transaction.amount, transaction.category);
                    }, 500);
                }
            }
            
            return transaction;
        }
        
        function updateTransaction(transactionId, updatedData) {
            const data = getUserData();
            const transactionIndex = data.transactions.findIndex(t => t.id === transactionId);
            
            if (transactionIndex === -1) return null;
            
            const oldTransaction = data.transactions[transactionIndex];
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ä—É—é —Å—É–º–º—É –≤ –±–∞–ª–∞–Ω—Å
            if (oldTransaction.type === 'income') {
                data.user.balance -= oldTransaction.amount;
            } else {
                data.user.balance += oldTransaction.amount;
            }
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–æ–≤—É—é —Å—É–º–º—É
            if (updatedData.type === 'income') {
                data.user.balance += updatedData.amount;
            } else {
                data.user.balance -= updatedData.amount;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
            data.transactions[transactionIndex] = {
                ...oldTransaction,
                ...updatedData,
                id: transactionId,
                date: oldTransaction.date
            };
            
            saveUserData(data);
            return data.transactions[transactionIndex];
        }
        
        function deleteTransactionById(transactionId) {
            const data = getUserData();
            const transactionIndex = data.transactions.findIndex(t => t.id === transactionId);
            
            if (transactionIndex === -1) return false;
            
            const transaction = data.transactions[transactionIndex];
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—É–º–º—É –≤ –±–∞–ª–∞–Ω—Å
            if (transaction.type === 'income') {
                data.user.balance -= transaction.amount;
            } else {
                data.user.balance += transaction.amount;
            }
            
            // –£–¥–∞–ª—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
            data.transactions.splice(transactionIndex, 1);
            
            saveUserData(data);
            return true;
        }
        
        function addGoal(goal) {
            const data = getUserData();
            goal.id = data.goals.length ? Math.max(...data.goals.map(g => g.id)) + 1 : 1;
            goal.created_at = new Date().toISOString();
            goal.completed = false;
            goal.current_amount = 0;
            goal.progress_percentage = 0;
            data.goals.unshift(goal);
            saveUserData(data);
            return goal;
        }
        
        function updateGoal(goalId, updatedData) {
            const data = getUserData();
            const goalIndex = data.goals.findIndex(g => g.id === goalId);
            
            if (goalIndex === -1) return null;
            
            const oldGoal = data.goals[goalIndex];
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–ª—å
            data.goals[goalIndex] = {
                ...oldGoal,
                ...updatedData,
                id: goalId,
                created_at: oldGoal.created_at
            };
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            const goal = data.goals[goalIndex];
            goal.progress_percentage = (goal.current_amount / goal.target_amount) * 100;
            goal.completed = goal.current_amount >= goal.target_amount;
            
            if (goal.completed && !oldGoal.completed) {
                goal.completed_at = new Date().toISOString();
            }
            
            saveUserData(data);
            return data.goals[goalIndex];
        }
        
        function addToGoal(goalId, amount, comment = '') {
            const data = getUserData();
            const goal = data.goals.find(g => g.id === goalId);
            
            if (!goal) return false;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ
            if (data.user.balance < amount) {
                showError('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ');
                return false;
            }
            
            // –°–Ω–∏–º–∞–µ–º –¥–µ–Ω—å–≥–∏ —Å –±–∞–ª–∞–Ω—Å–∞
            data.user.balance -= amount;
            
            // –ü–æ–ø–æ–ª–Ω—è–µ–º —Ü–µ–ª—å
            goal.current_amount += amount;
            goal.progress_percentage = (goal.current_amount / goal.target_amount) * 100;
            
            if (goal.current_amount >= goal.target_amount && !goal.completed) {
                goal.completed = true;
                goal.completed_at = new Date().toISOString();
            }
            
            // –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Ü–µ–ª–∏
            const transaction = {
                user_id: userId,
                amount: amount,
                category: '–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è',
                type: 'expense',
                description: `–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Ü–µ–ª–∏: ${goal.title}` + (comment ? ` (${comment})` : ''),
                tags: '—Ü–µ–ª—å, –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è'
            };
            
            addTransaction(transaction);
            
            saveUserData(data);
            return true;
        }
        
        function deleteGoalById(goalId) {
            const data = getUserData();
            const goalIndex = data.goals.findIndex(g => g.id === goalId);
            
            if (goalIndex === -1) return false;
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ–Ω—å–≥–∏ –Ω–∞ –±–∞–ª–∞–Ω—Å (–µ—Å–ª–∏ —Ü–µ–ª—å –Ω–µ –±—ã–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞)
            const goal = data.goals[goalIndex];
            if (!goal.completed && goal.current_amount > 0) {
                data.user.balance += goal.current_amount;
            }
            
            data.goals.splice(goalIndex, 1);
            saveUserData(data);
            return true;
        }
        
        function addInvestment(investment) {
            const data = getUserData();
            investment.id = data.investments.length ? Math.max(...data.investments.map(i => i.id)) + 1 : 1;
            investment.purchase_date = new Date().toISOString();
            investment.current_value = investment.amount_invested;
            investment.profit_loss = 0;
            investment.roi_percentage = 0;
            investment.current_price = investment.price_per_unit;
            data.investments.unshift(investment);
            saveUserData(data);
            
            // –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –Ω–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—é
            const transaction = {
                user_id: userId,
                amount: investment.amount_invested,
                category: '–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏',
                type: 'expense',
                description: `–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è: ${investment.asset_name}`,
                tags: '–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è'
            };
            
            addTransaction(transaction);
            
            return investment;
        }
        
        function updateInvestment(investmentId, updatedData) {
            const data = getUserData();
            const investmentIndex = data.investments.findIndex(i => i.id === investmentId);
            
            if (investmentIndex === -1) return null;
            
            const oldInvestment = data.investments[investmentIndex];
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—é
            data.investments[investmentIndex] = {
                ...oldInvestment,
                ...updatedData,
                id: investmentId,
                purchase_date: oldInvestment.purchase_date
            };
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏ –ø—Ä–∏–±—ã–ª—å
            const investment = data.investments[investmentIndex];
            investment.current_value = investment.quantity * investment.current_price;
            investment.profit_loss = investment.current_value - investment.amount_invested;
            investment.roi_percentage = investment.amount_invested > 0 ? 
                (investment.profit_loss / investment.amount_invested) * 100 : 0;
            
            saveUserData(data);
            return data.investments[investmentIndex];
        }
        
        function deleteInvestmentById(investmentId) {
            const data = getUserData();
            const investmentIndex = data.investments.findIndex(i => i.id === investmentId);
            
            if (investmentIndex === -1) return false;
            
            const investment = data.investments[investmentIndex];
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ–Ω—å–≥–∏ –Ω–∞ –±–∞–ª–∞–Ω—Å (—Ç–µ–∫—É—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å)
            data.user.balance += investment.current_value;
            
            // –£–¥–∞–ª—è–µ–º –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—é
            data.investments.splice(investmentIndex, 1);
            
            saveUserData(data);
            return true;
        }
        
        // ====================== –†–ê–°–ß–ï–¢–´ –ò –ê–ù–ê–õ–ò–¢–ò–ö–ê ======================
        
        function getFinancialSummary(period = 'month') {
            const data = getUserData();
            const now = new Date();
            let startDate = new Date();
            
            switch(period) {
                case 'week': startDate.setDate(now.getDate() - 7); break;
                case 'month': startDate.setMonth(now.getMonth() - 1); break;
                case 'year': startDate.setFullYear(now.getFullYear() - 1); break;
                case 'all': startDate = new Date(0); break;
            }
            
            const transactions = data.transactions.filter(t => new Date(t.date) >= startDate);
            
            const totalIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const totalExpenses = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const totalInvestments = data.investments
                .reduce((sum, i) => sum + i.current_value, 0);
            
            const netIncome = totalIncome - totalExpenses;
            const savingsRate = totalIncome > 0 ? (netIncome / totalIncome) * 100 : 0;
            
            // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ (–∏—Å–∫–ª—é—á–∞—è —Å–∫—Ä—ã—Ç—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
            const expenseStructure = [];
            const expenseByCategory = {};
            
            transactions
                .filter(t => t.type === 'expense')
                .forEach(t => {
                    if (!hiddenCategories.includes(t.category)) {
                        if (!expenseByCategory[t.category]) expenseByCategory[t.category] = 0;
                        expenseByCategory[t.category] += t.amount;
                    }
                });
            
            Object.entries(expenseByCategory).forEach(([category, amount]) => {
                expenseStructure.push({
                    category,
                    amount,
                    percentage: totalExpenses > 0 ? (amount / totalExpenses) * 100 : 0
                });
            });
            
            expenseStructure.sort((a, b) => b.amount - a.amount);
            
            // –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            const recentTransactions = transactions.slice(0, 5);
            
            return {
                summary: {
                    total_income: totalIncome,
                    total_expenses: totalExpenses,
                    total_investments: totalInvestments,
                    net_income: netIncome,
                    savings_rate: savingsRate,
                    total_transactions: transactions.length
                },
                expense_structure: expenseStructure,
                recent_transactions: recentTransactions,
                currency: '‚ÇΩ'
            };
        }
        
        function getFinancialHealthScore(summary) {
            let score = 50;
            
            const savingsRate = summary.summary.savings_rate;
            if (savingsRate >= 20) score += 30;
            else if (savingsRate >= 10) score += 20;
            else if (savingsRate >= 0) score += 10;
            else score -= 10;
            
            const expenseRatio = summary.summary.total_expenses / Math.max(summary.summary.total_income, 1) * 100;
            if (expenseRatio <= 70) score += 20;
            else if (expenseRatio <= 85) score += 10;
            else if (expenseRatio <= 100) score += 5;
            else score -= 10;
            
            const data = getUserData();
            if (data.goals && data.goals.length > 0) score += 10;
            if (data.investments && data.investments.length > 0) score += 10;
            
            return Math.min(Math.max(score, 0), 100);
        }
        
        // ====================== UI –û–ë–ù–û–í–õ–ï–ù–ò–Ø ======================
        
        function updateRecentTransactions(transactions) {
            const container = document.getElementById('recentTransactions');
            
            if (!transactions || transactions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exchange-alt"></i>
                        <div>–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞ –º–µ—Å—è—Ü</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            transactions.slice(0, 5).forEach(transaction => {
                const isIncome = transaction.type === 'income';
                const date = new Date(transaction.date);
                const formattedDate = date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
                
                html += `
                    <div class="transaction-item transaction-${transaction.type}">
                        <div class="transaction-icon">
                            <i class="fas fa-${isIncome ? 'arrow-up' : 'arrow-down'}"></i>
                        </div>
                        <div class="transaction-info">
                            <div class="transaction-category">${transaction.category}</div>
                            <div class="transaction-description">${transaction.description || ''}</div>
                            <div class="transaction-date">${formattedDate}</div>
                        </div>
                        <div class="transaction-amount">
                            ${isIncome ? '+' : '-'}${formatCurrency(transaction.amount)} ‚ÇΩ
                        </div>
                        <div class="transaction-actions">
                            <div class="action-icon" onclick="editTransaction(${transaction.id})">
                                <i class="fas fa-edit"></i>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ====================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –í–ö–õ–ê–î–ö–ê–ú–ò ======================
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const tabElement = document.getElementById(tabName + 'Tab');
            if (tabElement) {
                tabElement.classList.add('active');
                
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    if (tab.textContent.includes(getTabTitle(tabName))) {
                        tab.classList.add('active');
                    }
                });
                
                loadTabData(tabName);
            }
        }
        
        function getTabTitle(tabName) {
            const titles = {
                'dashboard': '–ì–ª–∞–≤–Ω–∞—è',
                'transactions': '–û–ø–µ—Ä–∞—Ü–∏–∏',
                'goals': '–¶–µ–ª–∏',
                'investments': '–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏',
                'profile': '–ü—Ä–æ—Ñ–∏–ª—å'
            };
            return titles[tabName];
        }
        
        function loadTabData(tabName) {
            switch(tabName) {
                case 'dashboard':
                    updateDashboardEnhanced();
                    break;
                case 'transactions':
                    loadTransactions();
                    break;
                case 'goals':
                    loadGoals();
                    break;
                case 'investments':
                    loadInvestments();
                    break;
                case 'profile':
                    loadProfile();
                    break;
            }
        }
        
        // ====================== –§–£–ù–ö–¶–ò–ò –ú–û–î–ê–õ–¨–ù–´–• –û–ö–û–ù ======================
        
        function showTransactionModal(type) {
            currentTransactionType = type;
            const modal = document.getElementById('transactionModal');
            const title = document.getElementById('modalTitle');
            
            title.textContent = type === 'income' ? '–î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥' : '–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥';
            loadCategoryOptions(type);
            
            document.getElementById('amountInput').value = '';
            document.getElementById('descriptionInput').value = '';
            document.getElementById('tagsInput').value = '';
            document.getElementById('customCategoryInput').value = '';
            
            modal.style.display = 'block';
            setTimeout(() => document.getElementById('amountInput').focus(), 300);
        }
        
        function editTransaction(transactionId) {
            const data = getUserData();
            const transaction = data.transactions.find(t => t.id === transactionId);
            
            if (!transaction) return;
            
            const modal = document.getElementById('editTransactionModal');
            
            document.getElementById('editTransactionId').value = transactionId;
            document.getElementById('editAmountInput').value = formatCurrency(transaction.amount);
            document.getElementById('editDescriptionInput').value = transaction.description || '';
            document.getElementById('editTagsInput').value = transaction.tags || '';
            document.getElementById('editTypeSelect').value = transaction.type;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const select = document.getElementById('editCategorySelect');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
            
            const categories = data.categories.filter(cat => cat.type === transaction.type);
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.name;
                option.textContent = `${cat.icon} ${cat.name}`;
                if (cat.name === transaction.category) option.selected = true;
                select.appendChild(option);
            });
            
            modal.style.display = 'block';
        }
        
        function saveEditedTransaction() {
            const transactionId = parseInt(document.getElementById('editTransactionId').value);
            const amount = parseCurrency(document.getElementById('editAmountInput').value);
            const category = document.getElementById('editCategorySelect').value;
            const type = document.getElementById('editTypeSelect').value;
            const description = document.getElementById('editDescriptionInput').value;
            const tags = document.getElementById('editTagsInput').value;
            
            if (!amount || amount <= 0) {
                showError('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
                return;
            }
            
            if (!category) {
                showError('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
                return;
            }
            
            const updatedTransaction = {
                amount: amount,
                category: category,
                type: type,
                description: description,
                tags: tags
            };
            
            updateTransaction(transactionId, updatedTransaction);
            
            closeEditModal();
            updateDashboardEnhanced();
            loadTransactions();
            showSuccessNotification('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
        }
        
        function deleteTransaction() {
            const transactionId = parseInt(document.getElementById('editTransactionId').value);
            
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é?')) {
                deleteTransactionById(transactionId);
                closeEditModal();
                updateDashboardEnhanced();
                loadTransactions();
                showSuccessNotification('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞!');
            }
        }
        
        function closeEditModal() {
            document.getElementById('editTransactionModal').style.display = 'none';
        }
        
        // ====================== –¶–ï–õ–ò ======================
        
        function showGoalModal() {
            const modal = document.getElementById('goalModal');
            const dateInput = document.getElementById('goalDeadline');
            
            // –°–±—Ä–æ—Å —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
            modal.querySelector('.modal-content').innerHTML = `
                <h2><i class="fas fa-bullseye"></i> –ù–æ–≤–∞—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Ü–µ–ª—å</h2>
                
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏</label>
                    <input type="text" id="goalTitle" class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù–æ–≤–∞—è –º–∞—à–∏–Ω–∞">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–°—É–º–º–∞ —Ü–µ–ª–∏ (‚ÇΩ)</label>
                    <div class="formatted-input-container">
                        <span class="currency-symbol">‚ÇΩ</span>
                        <input type="text" id="goalAmount" class="form-input formatted" placeholder="500 000" 
                               oninput="formatCurrencyInput(this)" onblur="validateCurrencyInput(this)"
                               inputmode="decimal" pattern="[0-9]*">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–°—Ä–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</label>
                    <input type="date" id="goalDeadline" class="form-input">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <select id="goalCategory" class="form-input">
                        <option value="–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è">–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è</option>
                        <option value="–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</option>
                        <option value="–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ">–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ</option>
                        <option value="–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ">–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</option>
                        <option value="–∂–∏–ª—å–µ">–ñ–∏–ª—å–µ</option>
                        <option value="—Ç–µ—Ö–Ω–∏–∫–∞">–¢–µ—Ö–Ω–∏–∫–∞</option>
                        <option value="–∞–≤—Ç–æ–º–æ–±–∏–ª—å">–ê–≤—Ç–æ–º–æ–±–∏–ª—å</option>
                        <option value="–∑–¥–æ—Ä–æ–≤—å–µ">–ó–¥–æ—Ä–æ–≤—å–µ</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                    <select id="goalPriority" class="form-input">
                        <option value="1">–í—ã—Å–æ–∫–∏–π</option>
                        <option value="2">–°—Ä–µ–¥–Ω–∏–π</option>
                        <option value="3">–ù–∏–∑–∫–∏–π</option>
                    </select>
                </div>
                
                <button class="btn btn-goal" onclick="submitGoal()">
                    <i class="fas fa-check"></i> –°–æ–∑–¥–∞—Ç—å —Ü–µ–ª—å
                </button>
                <button class="btn" onclick="closeModal()" style="margin-top: 10px;">
                    <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                </button>
            `;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            dateInput.min = tomorrow.toISOString().split('T')[0];
            
            const inThreeMonths = new Date();
            inThreeMonths.setMonth(inThreeMonths.getMonth() + 3);
            dateInput.value = inThreeMonths.toISOString().split('T')[0];
            
            modal.style.display = 'block';
            setTimeout(() => document.getElementById('goalTitle').focus(), 300);
        }
        
        function editGoal(goalId) {
            const data = getUserData();
            const goal = data.goals.find(g => g.id === goalId);
            
            if (!goal) return;
            
            const modal = document.getElementById('editGoalModal');
            
            document.getElementById('editGoalId').value = goalId;
            document.getElementById('editGoalTitle').value = goal.title;
            document.getElementById('editGoalCurrentAmount').value = formatCurrency(goal.current_amount);
            document.getElementById('editGoalTargetAmount').value = formatCurrency(goal.target_amount);
            document.getElementById('editGoalDeadline').value = goal.deadline;
            document.getElementById('editGoalCategory').value = goal.category;
            
            modal.style.display = 'block';
        }
        
        function saveEditedGoal() {
            const goalId = parseInt(document.getElementById('editGoalId').value);
            const title = document.getElementById('editGoalTitle').value.trim();
            const currentAmount = parseCurrency(document.getElementById('editGoalCurrentAmount').value);
            const targetAmount = parseCurrency(document.getElementById('editGoalTargetAmount').value);
            const deadline = document.getElementById('editGoalDeadline').value;
            const category = document.getElementById('editGoalCategory').value;
            
            if (!title) {
                showError('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏');
                return;
            }
            
            if (!targetAmount || targetAmount <= 0) {
                showError('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–ª–µ–≤—É—é —Å—É–º–º—É');
                return;
            }
            
            const updatedGoal = {
                title: title,
                current_amount: currentAmount,
                target_amount: targetAmount,
                deadline: deadline,
                category: category
            };
            
            updateGoal(goalId, updatedGoal);
            
            closeEditGoalModal();
            updateDashboardEnhanced();
            loadGoals();
            showSuccessNotification('–¶–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
        }
        
        function deleteGoal() {
            const goalId = parseInt(document.getElementById('editGoalId').value);
            
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ü–µ–ª—å?')) {
                deleteGoalById(goalId);
                closeEditGoalModal();
                updateDashboardEnhanced();
                loadGoals();
                showSuccessNotification('–¶–µ–ª—å —É–¥–∞–ª–µ–Ω–∞!');
            }
        }
        
        function closeEditGoalModal() {
            document.getElementById('editGoalModal').style.display = 'none';
        }
        
        function showAddToGoalModal(goalId) {
            const data = getUserData();
            const goal = data.goals.find(g => g.id === goalId);
            
            if (!goal) return;
            
            const modal = document.getElementById('addToGoalModal');
            
            document.getElementById('addToGoalId').value = goalId;
            document.getElementById('addToGoalAmount').value = '';
            document.getElementById('addToGoalComment').value = '';
            
            modal.style.display = 'block';
            setTimeout(() => document.getElementById('addToGoalAmount').focus(), 300);
        }
        
        function processAddToGoal() {
            const goalId = parseInt(document.getElementById('addToGoalId').value);
            const amount = parseCurrency(document.getElementById('addToGoalAmount').value);
            const comment = document.getElementById('addToGoalComment').value;
            
            if (!amount || amount <= 0) {
                showError('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
                return;
            }
            
            if (addToGoal(goalId, amount, comment)) {
                closeAddToGoalModal();
                updateDashboardEnhanced();
                loadGoals();
                showSuccessNotification(`–¶–µ–ª—å –ø–æ–ø–æ–ª–Ω–µ–Ω–∞ –Ω–∞ ${formatCurrency(amount)} ‚ÇΩ!`);
            }
        }
        
        function closeAddToGoalModal() {
            document.getElementById('addToGoalModal').style.display = 'none';
        }
        
        function loadGoals() {
            const data = getUserData();
            const activeGoals = data.goals.filter(g => !g.completed);
            const completedGoals = data.goals.filter(g => g.completed);
            
            updateGoalsList(activeGoals);
            updateCompletedGoalsList(completedGoals);
        }
        
        function updateGoalsList(goals) {
            const container = document.getElementById('goalsList');
            
            if (!goals || goals.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bullseye"></i>
                        <div>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ü–µ–ª–µ–π</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            goals.forEach(goal => {
                const deadline = new Date(goal.deadline);
                const now = new Date();
                const daysRemaining = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
                const progressPercentage = (goal.current_amount / goal.target_amount) * 100;
                const dailyRequired = daysRemaining > 0 ? 
                    (goal.target_amount - goal.current_amount) / daysRemaining : 0;
                
                html += `
                    <div class="goal-item">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: 600; font-size: 16px;">${goal.title}</div>
                                <div style="font-size: 14px; color: var(--text-color); opacity: 0.7; margin-top: 2px;">
                                    <i class="fas fa-tag"></i> ${goal.category}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 600; font-size: 18px;">${formatCurrency(goal.current_amount)} ‚ÇΩ</div>
                                <div style="font-size: 14px; color: var(--text-color); opacity: 0.7;">–∏–∑ ${formatCurrency(goal.target_amount)} ‚ÇΩ</div>
                            </div>
                        </div>
                        
                        <div class="goal-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                            </div>
                            <div class="progress-info">
                                <span>${progressPercentage.toFixed(1)}%</span>
                                <span style="color: ${daysRemaining > 0 ? 'var(--text-color)' : '#f44336'}; opacity: 0.7; font-size: 14px;">
                                    ${daysRemaining > 0 ? `‚è∞ ${daysRemaining} –¥–Ω. –æ—Å—Ç–∞–ª–æ—Å—å` : '‚ö†Ô∏è –°—Ä–æ–∫ –∏—Å—Ç–µ–∫'}
                                </span>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                            <div style="font-size: 14px; color: var(--text-color); opacity: 0.7;">
                                <i class="fas fa-calendar"></i> –°—Ä–æ–∫: ${goal.deadline}
                            </div>
                            <div style="font-size: 14px; color: var(--text-color); opacity: 0.7;">
                                <i class="fas fa-coins"></i> –ï–∂–µ–¥–Ω–µ–≤–Ω–æ: ${formatCurrency(dailyRequired)} ‚ÇΩ
                            </div>
                        </div>
                        
                        <div class="goal-actions">
                            <button class="goal-btn" onclick="showAddToGoalModal(${goal.id})">
                                <i class="fas fa-plus"></i> –ü–æ–ø–æ–ª–Ω–∏—Ç—å
                            </button>
                            <button class="goal-btn" onclick="editGoal(${goal.id})">
                                <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function updateCompletedGoalsList(goals) {
            const container = document.getElementById('completedGoalsList');
            
            if (!goals || goals.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-trophy"></i>
                        <div>–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã—Ö —Ü–µ–ª–µ–π</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            goals.forEach(goal => {
                const completedDate = new Date(goal.completed_at);
                const formattedDate = completedDate.toLocaleDateString('ru-RU');
                
                html += `
                    <div class="goal-item" style="border-left-color: #4CAF50; background: linear-gradient(90deg, rgba(76, 175, 80, 0.1) 0%, var(--bg-color) 100%);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: 600; font-size: 16px; color: #4CAF50;">${goal.title}</div>
                                <div style="font-size: 14px; color: var(--text-color); opacity: 0.7; margin-top: 2px;">
                                    <i class="fas fa-tag"></i> ${goal.category}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 600; font-size: 18px; color: #4CAF50;">${formatCurrency(goal.target_amount)} ‚ÇΩ</div>
                                <div style="font-size: 14px; color: var(--text-color); opacity: 0.7;">–¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                            <div style="font-size: 14px; color: var(--text-color); opacity: 0.7;">
                                <i class="fas fa-calendar-check"></i> –î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ: ${formattedDate}
                            </div>
                            <div style="font-size: 14px; color: #4CAF50; font-weight: 600;">
                                <i class="fas fa-trophy"></i> –í—ã–ø–æ–ª–Ω–µ–Ω–æ!
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ====================== –ò–ù–í–ï–°–¢–ò–¶–ò–ò ======================
        
        function showInvestmentModal() {
            const modal = document.getElementById('investmentModal');
            
            document.getElementById('investmentType').value = 'stock';
            document.getElementById('investmentName').value = '';
            document.getElementById('investmentPrice').value = '';
            document.getElementById('investmentQuantity').value = '1';
            document.getElementById('investmentAmount').value = '';
            
            modal.style.display = 'block';
            setTimeout(() => document.getElementById('investmentName').focus(), 300);
        }
        
        function editInvestment(investmentId) {
            const data = getUserData();
            const investment = data.investments.find(i => i.id === investmentId);
            
            if (!investment) return;
            
            const modal = document.getElementById('editInvestmentModal');
            
            document.getElementById('editInvestmentId').value = investmentId;
            document.getElementById('editInvestmentType').value = investment.asset_type;
            document.getElementById('editInvestmentName').value = investment.asset_name;
            document.getElementById('editInvestmentPrice').value = formatCurrency(investment.price_per_unit);
            document.getElementById('editInvestmentQuantity').value = investment.quantity;
            document.getElementById('editInvestmentCurrentPrice').value = formatCurrency(investment.current_price);
            document.getElementById('editInvestmentAmount').value = formatCurrency(investment.amount_invested);
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
            calculateEditInvestmentTotal();
            calculateEditInvestmentProfit();
            
            modal.style.display = 'block';
        }
        
        function calculateEditInvestmentTotal() {
            const price = parseCurrency(document.getElementById('editInvestmentPrice').value) || 0;
            const quantity = parseFloat(document.getElementById('editInvestmentQuantity').value) || 0;
            const total = price * quantity;
            document.getElementById('editInvestmentAmount').value = formatCurrency(total);
        }
        
        function calculateEditInvestmentProfit() {
            const currentPrice = parseCurrency(document.getElementById('editInvestmentCurrentPrice').value) || 0;
            const quantity = parseFloat(document.getElementById('editInvestmentQuantity').value) || 0;
            const invested = parseCurrency(document.getElementById('editInvestmentAmount').value) || 0;
            
            const currentValue = currentPrice * quantity;
            const profit = currentValue - invested;
            
            document.getElementById('editInvestmentCurrentValue').value = formatCurrency(currentValue);
            document.getElementById('editInvestmentProfit').value = formatCurrency(profit);
        }
        
        function saveEditedInvestment() {
            const investmentId = parseInt(document.getElementById('editInvestmentId').value);
            const assetType = document.getElementById('editInvestmentType').value;
            const assetName = document.getElementById('editInvestmentName').value.trim();
            const pricePerUnit = parseCurrency(document.getElementById('editInvestmentPrice').value);
            const quantity = parseFloat(document.getElementById('editInvestmentQuantity').value) || 1;
            const currentPrice = parseCurrency(document.getElementById('editInvestmentCurrentPrice').value);
            
            if (!assetName) {
                showError('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–∞');
                return;
            }
            
            if (!pricePerUnit || pricePerUnit <= 0) {
                showError('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É');
                return;
            }
            
            if (!quantity || quantity <= 0) {
                showError('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ');
                return;
            }
            
            const updatedInvestment = {
                asset_type: assetType,
                asset_name: assetName,
                price_per_unit: pricePerUnit,
                quantity: quantity,
                amount_invested: pricePerUnit * quantity,
                current_price: currentPrice || pricePerUnit
            };
            
            updateInvestment(investmentId, updatedInvestment);
            
            closeEditInvestmentModal();
            updateDashboardEnhanced();
            loadInvestments();
            showSuccessNotification('–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
        }
        
        function deleteInvestment() {
            const investmentId = parseInt(document.getElementById('editInvestmentId').value);
            
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—é? –°—Ä–µ–¥—Å—Ç–≤–∞ –≤–µ—Ä–Ω—É—Ç—Å—è –Ω–∞ –±–∞–ª–∞–Ω—Å.')) {
                deleteInvestmentById(investmentId);
                closeEditInvestmentModal();
                updateDashboardEnhanced();
                loadInvestments();
                showSuccessNotification('–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞! –°—Ä–µ–¥—Å—Ç–≤–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –Ω–∞ –±–∞–ª–∞–Ω—Å.');
            }
        }
        
        function closeEditInvestmentModal() {
            document.getElementById('editInvestmentModal').style.display = 'none';
        }
        
        function calculateInvestmentTotal() {
            const price = parseCurrency(document.getElementById('investmentPrice').value) || 0;
            const quantity = parseFloat(document.getElementById('investmentQuantity').value) || 0;
            const total = price * quantity;
            document.getElementById('investmentAmount').value = formatCurrency(total);
        }
        
        function loadInvestments() {
            const data = getUserData();
            updateInvestmentsList(data.investments);
        }
        
        function updateInvestmentsList(investments) {
            const container = document.getElementById('investmentsList');
            
            if (!investments || investments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-chart-line"></i>
                        <div>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π</div>
                    </div>
                `;
                return;
            }
            
            let totalInvested = 0;
            let totalCurrent = 0;
            
            let html = '';
            investments.forEach(inv => {
                const profitLoss = inv.profit_loss || 0;
                const roi = inv.roi_percentage || 0;
                const isPositive = profitLoss >= 0;
                
                totalInvested += inv.amount_invested;
                totalCurrent += inv.current_value || inv.amount_invested;
                
                html += `
                    <div class="investment-card">
                        <div class="investment-actions">
                            <div class="action-icon" onclick="editInvestment(${inv.id})">
                                <i class="fas fa-edit"></i>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: 600; font-size: 16px;">${inv.asset_name}</div>
                                <div style="font-size: 14px; color: var(--text-color); opacity: 0.7; margin-top: 2px;">
                                    <i class="fas fa-${getInvestmentIcon(inv.asset_type)}"></i> ${getInvestmentTypeName(inv.asset_type)}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 600; font-size: 18px;">${formatCurrency(inv.current_value || inv.amount_invested)} ‚ÇΩ</div>
                                <div style="font-size: 14px; color: var(--text-color); opacity: 0.7;">${inv.quantity} —à—Ç.</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                            <div style="font-size: 14px; color: var(--text-color); opacity: 0.7;">
                                –¶–µ–Ω–∞: ${formatCurrency(inv.price_per_unit || (inv.amount_invested / inv.quantity))} ‚ÇΩ
                            </div>
                            <div class="performance-badge ${isPositive ? 'positive' : 'negative'}">
                                ${isPositive ? 'üìà' : 'üìâ'} ${profitLoss >= 0 ? '+' : ''}${formatCurrency(profitLoss)} ‚ÇΩ (${roi.toFixed(1)}%)
                            </div>
                        </div>
                        
                        <div style="font-size: 14px; color: var(--text-color); opacity: 0.7; margin-top: 5px;">
                            <i class="fas fa-calendar"></i> –ö—É–ø–ª–µ–Ω–æ: ${new Date(inv.purchase_date).toLocaleDateString('ru-RU')}
                        </div>
                    </div>
                `;
            });
            
            const totalProfit = totalCurrent - totalInvested;
            const totalRoi = totalInvested > 0 ? (totalProfit / totalInvested * 100) : 0;
            
            html += `
                <div style="background: var(--card-bg); padding: 15px; border-radius: 12px; margin-top: 15px; border: 1px solid var(--border-color);">
                    <div style="font-weight: 600; margin-bottom: 10px; text-align: center; color: var(--text-color);">–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; text-align: center;">
                        <div>
                            <div style="font-size: 12px; color: var(--text-color); opacity: 0.7;">–í—Å–µ–≥–æ –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ</div>
                            <div style="font-weight: 600; font-size: 16px; color: var(--text-color);">${formatCurrency(totalInvested)} ‚ÇΩ</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: var(--text-color); opacity: 0.7;">–¢–µ–∫—É—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
                            <div style="font-weight: 600; font-size: 16px; color: var(--text-color);">${formatCurrency(totalCurrent)} ‚ÇΩ</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: var(--text-color); opacity: 0.7;">–ü—Ä–∏–±—ã–ª—å/—É–±—ã—Ç–æ–∫</div>
                            <div style="font-weight: 600; font-size: 16px; color: ${totalProfit >= 0 ? '#4CAF50' : '#f44336'}">
                                ${totalProfit >= 0 ? '+' : ''}${formatCurrency(totalProfit)} ‚ÇΩ
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: var(--text-color); opacity: 0.7;">–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å (ROI)</div>
                            <div style="font-weight: 600; font-size: 16px; color: ${totalRoi >= 0 ? '#4CAF50' : '#f44336'}">
                                ${totalRoi >= 0 ? '+' : ''}${totalRoi.toFixed(1)}%
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // ====================== –†–ï–§–ï–†–ê–õ–¨–ù–ê–Ø –°–ò–°–¢–ï–ú–ê ======================
        
        function showReferralModal() {
            updateReferralModal();
            document.getElementById('referralModal').style.display = 'block';
        }
        
        function closeReferralModal() {
            document.getElementById('referralModal').style.display = 'none';
        }
        
        function copyReferralLink() {
            const input = document.getElementById('referralLinkInput');
            input.select();
            document.execCommand('copy');
            showSuccessNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
        }
        
        // ====================== –û–¢–ß–ï–¢–´ ======================
        
        function generateReport(type) {
            const data = getUserData();
            const summary = getFinancialSummary(type === 'monthly' ? 'month' : 'year');
            
            let reportText = `–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç (${type === 'monthly' ? '–º–µ—Å—è—á–Ω—ã–π' : '–≥–æ–¥–æ–≤–æ–π'})\n`;
            reportText += `–î–∞—Ç–∞: ${new Date().toLocaleDateString('ru-RU')}\n`;
            reportText += `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${data.user.full_name}\n`;
            reportText += `–ü–µ—Ä–∏–æ–¥: ${type === 'monthly' ? '–∑–∞ –º–µ—Å—è—Ü' : '–∑–∞ –≥–æ–¥'}\n\n`;
            
            reportText += `üìä –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:\n`;
            reportText += `–ë–∞–ª–∞–Ω—Å: ${formatCurrency(data.user.balance)} ‚ÇΩ\n`;
            reportText += `–î–æ—Ö–æ–¥—ã: ${formatCurrency(summary.summary.total_income)} ‚ÇΩ\n`;
            reportText += `–†–∞—Å—Ö–æ–¥—ã: ${formatCurrency(summary.summary.total_expenses)} ‚ÇΩ\n`;
            reportText += `–ß–∏—Å—Ç—ã–π –¥–æ—Ö–æ–¥: ${formatCurrency(summary.summary.net_income)} ‚ÇΩ\n`;
            reportText += `–ù–æ—Ä–º–∞ —Å–±–µ—Ä–µ–∂–µ–Ω–∏–π: ${summary.summary.savings_rate.toFixed(1)}%\n\n`;
            
            reportText += `üéØ –¶–ï–õ–ò:\n`;
            const activeGoals = data.goals.filter(g => !g.completed);
            const completedGoals = data.goals.filter(g => g.completed);
            reportText += `–ê–∫—Ç–∏–≤–Ω—ã—Ö: ${activeGoals.length}\n`;
            reportText += `–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö: ${completedGoals.length}\n\n`;
            
            reportText += `üìà –ò–ù–í–ï–°–¢–ò–¶–ò–ò:\n`;
            reportText += `–í—Å–µ–≥–æ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π: ${data.investments.length}\n`;
            reportText += `–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${formatCurrency(summary.summary.total_investments)} ‚ÇΩ\n\n`;
            
            reportText += `üíº –û–ü–ï–†–ê–¶–ò–ò:\n`;
            reportText += `–í—Å–µ–≥–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: ${data.transactions.length}\n`;
            reportText += `–î–æ—Ö–æ–¥–æ–≤: ${data.transactions.filter(t => t.type === 'income').length}\n`;
            reportText += `–†–∞—Å—Ö–æ–¥–æ–≤: ${data.transactions.filter(t => t.type === 'expense').length}\n`;
            
            showSuccessNotification('–û—Ç—á–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω!');
            console.log(reportText);
        }
        
        function exportToCSV() {
            const data = getUserData();
            const summary = getFinancialSummary('all');
            
            let csv = '–ö–∞—Ç–µ–≥–æ—Ä–∏—è,–°—É–º–º–∞,–¢–∏–ø,–î–∞—Ç–∞,–û–ø–∏—Å–∞–Ω–∏–µ\n';
            
            // –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            data.transactions.forEach(t => {
                const date = new Date(t.date).toLocaleDateString('ru-RU');
                csv += `"${t.category}",${t.amount},"${t.type}","${date}","${t.description || ''}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `transactions_${userId}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showSuccessNotification('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ CSV!');
        }
        
        function exportToExcel() {
            const data = getUserData();
            
            let html = `
                <html>
                <head>
                    <meta charset="UTF-8">
                    <style>
                        table { border-collapse: collapse; width: 100%; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    <h1>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç</h1>
                    <h3>–î–∞—Ç–∞: ${new Date().toLocaleDateString('ru-RU')}</h3>
                    <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${data.user.full_name}</h3>
                    
                    <h2>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h2>
                    <table>
                        <tr>
                            <th>–î–∞—Ç–∞</th>
                            <th>–¢–∏–ø</th>
                            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                            <th>–°—É–º–º–∞ (‚ÇΩ)</th>
                            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                        </tr>
            `;
            
            data.transactions.forEach(t => {
                const date = new Date(t.date).toLocaleDateString('ru-RU');
                html += `
                    <tr>
                        <td>${date}</td>
                        <td>${t.type === 'income' ? '–î–æ—Ö–æ–¥' : '–†–∞—Å—Ö–æ–¥'}</td>
                        <td>${t.category}</td>
                        <td>${formatCurrency(t.amount)}</td>
                        <td>${t.description || ''}</td>
                    </tr>
                `;
            });
            
            html += `
                    </table>
                </body>
                </html>
            `;
            
            const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `finance_report_${userId}_${new Date().toISOString().split('T')[0]}.xls`;
            link.click();
            
            showSuccessNotification('–û—Ç—á–µ—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ Excel!');
        }
        
        function clearAllData() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.')) {
                const userDataKey = `finance_user_${userId}`;
                localStorage.removeItem(userDataKey);
                localStorage.removeItem(`hidden_categories_${userId}`);
                localStorage.removeItem(`monthly_memory_${userId}`);
                localStorage.removeItem(`welcome_shown_${userId}`);
                
                initUserData();
                hiddenCategories = [];
                monthlyMemory = {};
                
                updateDashboardEnhanced();
                loadTransactions();
                loadGoals();
                loadInvestments();
                loadProfile();
                showSuccessNotification('–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã!');
            }
        }
        
        // ====================== –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ======================
        
        function loadCategoryOptions(type) {
            const select = document.getElementById('categorySelect');
            const customGroup = document.getElementById('customCategoryGroup');
            
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
            selectedCategory = '';
            customGroup.style.display = 'none';
            
            const data = getUserData();
            const categories = data.categories.filter(cat => cat.type === type);
            
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.name;
                option.textContent = `${cat.icon} ${cat.name}`;
                select.appendChild(option);
            });
            
            if (!categories.find(cat => cat.name === '–¥—Ä—É–≥–æ–µ')) {
                const otherOption = document.createElement('option');
                otherOption.value = '–¥—Ä—É–≥–æ–µ';
                otherOption.textContent = 'üìå –î—Ä—É–≥–æ–µ (–≤–≤–µ—Å—Ç–∏ —Å–≤–æ—é)';
                select.appendChild(otherOption);
            }
        }
        
        function handleCategorySelect() {
            const select = document.getElementById('categorySelect');
            const customGroup = document.getElementById('customCategoryGroup');
            
            if (select.value === '–¥—Ä—É–≥–æ–µ') {
                customGroup.style.display = 'block';
                selectedCategory = '';
                setTimeout(() => document.getElementById('customCategoryInput').focus(), 100);
            } else {
                customGroup.style.display = 'none';
                selectedCategory = select.value;
            }
        }
        
        function submitTransaction() {
            const amount = parseCurrency(document.getElementById('amountInput').value);
            const description = document.getElementById('descriptionInput').value;
            const tags = document.getElementById('tagsInput').value;
            const categorySelect = document.getElementById('categorySelect');
            const customCategory = document.getElementById('customCategoryInput').value;
            
            if (!amount || amount <= 0) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
                return;
            }
            
            let category = categorySelect.value;
            if (category === '–¥—Ä—É–≥–æ–µ' && customCategory) {
                category = customCategory.trim();
            }
            
            if (!category) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
                return;
            }
            
            const transaction = addTransaction({
                user_id: userId,
                amount: amount,
                category: category,
                type: currentTransactionType,
                description: description,
                tags: tags
            });
            
            updateDashboardEnhanced();
            closeModal();
            showSuccessNotification('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
        }
        
        function submitGoal() {
            submitGoalEnhanced();
        }
        
        function submitInvestment() {
            const assetType = document.getElementById('investmentType').value;
            const assetName = document.getElementById('investmentName').value.trim();
            const price = parseCurrency(document.getElementById('investmentPrice').value);
            const quantity = parseFloat(document.getElementById('investmentQuantity').value) || 1;
            const total = parseCurrency(document.getElementById('investmentAmount').value);
            
            if (!assetName) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–∞');
                return;
            }
            
            if (!price || price <= 0) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É');
                return;
            }
            
            if (!quantity || quantity <= 0) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ');
                return;
            }
            
            const investment = addInvestment({
                user_id: userId,
                asset_type: assetType,
                asset_name: assetName,
                price_per_unit: price,
                quantity: quantity,
                amount_invested: total
            });
            
            loadInvestments();
            updateDashboardEnhanced();
            closeModal();
            showSuccessNotification('–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
        }
        
        function closeModal() {
            document.getElementById('transactionModal').style.display = 'none';
            document.getElementById('goalModal').style.display = 'none';
            document.getElementById('investmentModal').style.display = 'none';
            selectedCategory = '';
        }
        
        function loadTransactions() {
            const data = getUserData();
            updateTransactionsListFull(data.transactions);
        }
        
        function updateTransactionsListFull(transactions) {
            const container = document.getElementById('transactionsList');
            
            if (!transactions || transactions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exchange-alt"></i>
                        <div>–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            transactions.forEach(transaction => {
                const isIncome = transaction.type === 'income';
                const date = new Date(transaction.date);
                const formattedDate = date.toLocaleDateString('ru-RU', { 
                    day: '2-digit', 
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const tags = transaction.tags ? 
                    transaction.tags.split(',').map(tag => `<span style="background: var(--border-color); padding: 2px 6px; border-radius: 10px; font-size: 11px; margin-right: 5px; color: var(--text-color);">${tag.trim()}</span>`).join('') : '';
                
                html += `
                    <div class="transaction-item transaction-${transaction.type}">
                        <div class="transaction-icon">
                            <i class="fas fa-${isIncome ? 'arrow-up' : 'arrow-down'}"></i>
                        </div>
                        <div class="transaction-info">
                            <div class="transaction-category">${transaction.category}</div>
                            <div class="transaction-description">${transaction.description || ''}</div>
                            <div style="margin-top: 5px;">${tags}</div>
                            <div class="transaction-date">${formattedDate}</div>
                        </div>
                        <div class="transaction-amount">
                            ${isIncome ? '+' : '-'}${formatCurrency(transaction.amount)} ‚ÇΩ
                        </div>
                        <div class="transaction-actions">
                            <div class="action-icon" onclick="editTransaction(${transaction.id})">
                                <i class="fas fa-edit"></i>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function filterTransactions() {
            const typeFilter = document.getElementById('transactionTypeFilter').value;
            const periodFilter = document.getElementById('transactionPeriodFilter').value;
            
            const data = getUserData();
            let filtered = data.transactions;
            
            if (typeFilter !== 'all') {
                filtered = filtered.filter(t => t.type === typeFilter);
            }
            
            if (periodFilter !== 'all') {
                const now = new Date();
                let startDate = new Date();
                
                switch(periodFilter) {
                    case 'week': startDate.setDate(now.getDate() - 7); break;
                    case 'month': startDate.setMonth(now.getMonth() - 1); break;
                    case 'year': startDate.setFullYear(now.getFullYear() - 1); break;
                }
                
                filtered = filtered.filter(t => new Date(t.date) >= startDate);
            }
            
            updateTransactionsListFull(filtered);
        }
        
        function loadProfile() {
            const data = getUserData();
            updateProfileInfo(data.user);
        }
        
        function updateProfileInfo(user) {
            const container = document.getElementById('profileInfo');
            
            const html = `
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                    <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color), #2481cc); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold;">
                        ${user.full_name ? user.full_name.charAt(0).toUpperCase() : '?'}
                    </div>
                    <div>
                        <div style="font-weight: 600; font-size: 18px; color: var(--text-color);">${user.full_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                        <div style="font-size: 14px; color: var(--text-color); opacity: 0.7;">${initData.user?.username ? '@' + initData.user.username : '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="background: var(--bg-color); padding: 12px; border-radius: 10px; border: 1px solid var(--border-color);">
                        <div style="font-size: 12px; color: var(--text-color); opacity: 0.7;">–û—Å–Ω–æ–≤–Ω–æ–π –¥–æ—Ö–æ–¥</div>
                        <div style="font-weight: 600; font-size: 16px; color: var(--text-color);">${user.main_income ? formatCurrency(user.main_income) + ' ‚ÇΩ' : '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                    </div>
                    <div style="background: var(--bg-color); padding: 12px; border-radius: 10px; border: 1px solid var(--border-color);">
                        <div style="font-size: 12px; color: var(--text-color); opacity: 0.7;">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</div>
                        <div style="font-weight: 600; font-size: 16px; color: var(--text-color);">${formatCurrency(user.balance)} ‚ÇΩ</div>
                    </div>
                </div>
                
                <div style="font-size: 14px; color: var(--text-color); opacity: 0.7; text-align: center; margin-top: 15px;">
                    <i class="fas fa-calendar"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω ${new Date(user.registration_date).toLocaleDateString('ru-RU')}
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function getInvestmentIcon(type) {
            const icons = {
                'stock': 'chart-line',
                'crypto': 'bitcoin',
                'bond': 'hand-holding-usd',
                'real_estate': 'home',
                'other': 'coins'
            };
            return icons[type] || 'coins';
        }
        
        function getInvestmentTypeName(type) {
            const names = {
                'stock': '–ê–∫—Ü–∏–∏',
                'crypto': '–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞',
                'bond': '–û–±–ª–∏–≥–∞—Ü–∏–∏',
                'real_estate': '–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å',
                'other': '–î—Ä—É–≥–æ–µ'
            };
            return names[type] || '–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è';
        }
        
        function getTextColor() {
            const isDark = document.documentElement.style.getPropertyValue('--bg-color') === '#18222d' || 
                          document.documentElement.style.getPropertyValue('--bg-color') === '#000000' ||
                          document.documentElement.style.getPropertyValue('--bg-color') === '#0f0f0f';
            return isDark ? '#ffffff' : '#000000';
        }
        
        function showLoader() {
            document.getElementById('loader').classList.remove('hidden');
        }
        
        function hideLoader() {
            document.getElementById('loader').classList.add('hidden');
        }
        
        function showError(message) {
            if (tg.showAlert) {
                tg.showAlert(message);
            } else {
                alert(message);
            }
        }
        
        function showSuccess(message) {
            if (tg.showAlert) {
                tg.showAlert(message);
            } else {
                alert(message);
            }
        }
        
        function showDetailedReport(type) {
            const summary = getFinancialSummary('month');
            let reportText = `–û—Ç—á–µ—Ç –ø–æ ${type === 'income' ? '–¥–æ—Ö–æ–¥–∞–º' : '—Ä–∞—Å—Ö–æ–¥–∞–º'}:\n\n`;
            
            if (type === 'income') {
                reportText += `–í—Å–µ–≥–æ –¥–æ—Ö–æ–¥–æ–≤: ${formatCurrency(summary.summary.total_income)} ‚ÇΩ\n`;
            } else {
                reportText += `–í—Å–µ–≥–æ —Ä–∞—Å—Ö–æ–¥–æ–≤: ${formatCurrency(summary.summary.total_expenses)} ‚ÇΩ\n\n`;
                summary.expense_structure.forEach(item => {
                    reportText += `${item.category}: ${formatCurrency(item.amount)} ‚ÇΩ (${item.percentage.toFixed(1)}%)\n`;
                });
            }
            
            showSuccess(reportText);
        }
        
        function loadMoreAdvice() {
            const summary = getFinancialSummary('month');
            const advice = updateSmartAdvice(summary);
            updateAdvice(advice);
            showSuccessNotification('–°–æ–≤–µ—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã!');
        }
        
        function updateAdvice(advice) {
            const container = document.getElementById('adviceContainer');
            
            if (!advice || advice.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-lightbulb"></i>
                        <div>–î–æ–±–∞–≤—å—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–≤–µ—Ç–æ–≤</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            advice.forEach(item => {
                const priorityClass = item.priority === 1 ? 'high' : item.priority === 2 ? 'medium' : '';
                html += `
                    <div class="advice-item ${priorityClass}">
                        <div style="font-weight: 600; margin-bottom: 5px; color: var(--text-color);">${item.advice_text}</div>
                        <div style="font-size: 12px; color: var(--text-color); opacity: 0.7;">
                            ${item.priority === 1 ? '–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç' : item.priority === 2 ? '–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç' : '–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç'}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ====================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ======================
        
        document.addEventListener('DOMContentLoaded', () => {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            showWelcomeMessage();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—à–±–æ—Ä–¥
            updateDashboardEnhanced();
            updateTheme();
            
            tg.onEvent('themeChanged', updateTheme);
            tg.onEvent('viewportChanged', () => {
                tg.expand();
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—à–±–æ—Ä–¥ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(() => {
                updateDashboardEnhanced();
            }, 30000);
        });
        
        function updateTheme() {
            if (tg.themeParams) {
                document.documentElement.style.setProperty('--bg-color', tg.themeParams.bg_color || '#ffffff');
                document.documentElement.style.setProperty('--text-color', tg.themeParams.text_color || '#000000');
                document.documentElement.style.setProperty('--card-bg', tg.themeParams.secondary_bg_color || '#f8f9fa');
                document.documentElement.style.setProperty('--border-color', tg.themeParams.hint_color || '#e0e0e0');
                document.documentElement.style.setProperty('--button-color', tg.themeParams.button_color || '#40a7e3');
                document.documentElement.style.setProperty('--button-text-color', tg.themeParams.button_text_color || '#ffffff');
                document.documentElement.style.setProperty('--transaction-bg', tg.themeParams.secondary_bg_color || '#f8f9fa');
            }
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
        window.onclick = function(event) {
            const modals = ['transactionModal', 'goalModal', 'investmentModal', 
                           'editTransactionModal', 'editGoalModal', 'addToGoalModal',
                           'editInvestmentModal', 'goalAllocationModal', 'referralModal',
                           'expenseDetailsModal'];
            
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    if (modalId === 'goalAllocationModal') {
                        modal.remove();
                    } else {
                        modal.style.display = 'none';
                    }
                }
            });
        };
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
                closeEditModal();
                closeEditGoalModal();
                closeAddToGoalModal();
                closeEditInvestmentModal();
                closeReferralModal();
                closeExpenseDetails();
                const allocationModal = document.getElementById('goalAllocationModal');
                if (allocationModal) allocationModal.remove();
            }
        });
    </script>
</body>
</html>
